<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edge System Dashboard</title>
<style>

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    :root {
      --white: #ffffff; --bg: #f7f8fa; --card-bg: #ffffff; --border: #e8eaed; --border-light: #f1f3f5;
      --text-primary: #1a1a2e; --text-secondary: #6b7280; --text-muted: #9ca3af;
      --accent: #2563eb; --accent-light: #dbeafe;
      --green: #10b981; --green-light: #d1fae5;
      --red: #ef4444; --red-light: #fee2e2;
      --orange: #f59e0b; --orange-light: #fef3c7;
      --purple: #8b5cf6; --purple-light: #ede9fe;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04); --shadow-md: 0 4px 12px rgba(0,0,0,0.06); --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
      --radius: 12px; --radius-sm: 8px; --radius-lg: 16px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; }
    .header { background: var(--white); border-bottom: 1px solid var(--border); padding: 16px 28px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 200; box-shadow: var(--shadow-sm); }
    .header h1, .header .title { font-size: 18px; font-weight: 800; color: var(--accent); letter-spacing: -0.3px; }
    .header .subtitle, .header p, .header small { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .header-right, .header-actions, .header .actions { display: flex; gap: 8px; align-items: center; }
    button, .btn { font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600; border: none; border-radius: var(--radius-sm); padding: 8px 16px; cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; gap: 6px; }
    button:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-primary, button[style*="background: #00d4aa"], button[style*="background:#00d4aa"] { background: var(--green) !important; color: white !important; }
    .btn-danger, button[style*="background: #ef4444"] { background: var(--red) !important; color: white !important; }
    .espn-btn, button[onclick*="espn"] { background: var(--white); color: var(--text-secondary); border: 1px solid var(--border); font-size: 12px; padding: 6px 12px; }
    #soundToggle { background: var(--green) !important; color: white !important; border-radius: 20px !important; padding: 6px 14px !important; font-size: 12px !important; font-weight: 600 !important; }
    #demoToggle { background: var(--accent) !important; color: white !important; border-radius: 20px !important; padding: 6px 14px !important; font-size: 12px !important; font-weight: 600 !important; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .status-dot.green, .status-dot.live { background: var(--green); }
    .status-dot.red, .status-dot.off { background: var(--red); }
    .tab-bar { display: flex; background: var(--white); border-bottom: 1px solid var(--border); padding: 0 28px; position: sticky; top: 56px; z-index: 100; gap: 0; }
    .tab { padding: 14px 20px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-muted); border-bottom: 2px solid transparent; transition: all 0.15s ease; white-space: nowrap; }
    .tab:hover { color: var(--text-primary); background: var(--bg); }
    .tab.active { color: var(--accent); font-weight: 600; border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .content, .main-content, .tab-content { padding: 24px 28px; max-width: 1400px; margin: 0 auto; }
    h2, .section-title { font-size: 20px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.3px; margin-bottom: 4px; }
    h3, h4 { font-size: 15px; font-weight: 700; color: var(--text-primary); }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 16px; text-align: center; box-shadow: var(--shadow-sm); transition: all 0.2s ease; }
    .stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .stat-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px; }
    .stat-value { font-size: 28px; font-weight: 800; color: var(--text-primary); letter-spacing: -1px; }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); margin-bottom: 16px; transition: all 0.2s ease; }
    .card:hover { box-shadow: var(--shadow-md); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 700; font-size: 15px; color: var(--text-primary); }
    .card-body { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
    .games-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .game-card{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:box-shadow .2s ease}
        .game-card:hover{box-shadow:var(--shadow-md)}
        .game-card-header{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;background:var(--bg);border-bottom:1px solid var(--border-light);font-size:11px;color:var(--text-muted);font-weight:500;letter-spacing:.3px}
        .game-card-body{padding:10px 12px}
        .game-teams{display:flex;align-items:center;justify-content:space-between;gap:4px}
        .team-block{text-align:center;flex:1}
        .team-block strong,.team-block b{display:block;font-size:15px;font-weight:700;color:var(--text-primary);margin-bottom:1px}
        .team-block small{font-size:11px;color:var(--text-muted)}
        .vs-block{padding:0 6px;color:var(--text-muted);font-size:12px;font-weight:500}
        .sound-toggle{display:none!important}
        .scenario-alert-panel{position:fixed;bottom:0;left:0;right:0;z-index:500;background:var(--white);border-top:1px solid var(--border);box-shadow:0 -4px 20px rgba(0,0,0,.08);padding:12px 24px;max-height:160px;overflow-y:auto}
        .demo-btn{background:var(--white);border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s}
        .demo-btn:hover{background:var(--bg);border-color:var(--accent);color:var(--accent)}
        .stat-card{transition:all .2s ease}
        .stat-card:hover{box-shadow:var(--shadow-md);border-color:var(--accent)}
        .stat-label{font-size:10px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
        .stat-value{font-size:28px;font-weight:800;letter-spacing:-1px}
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted);font-size:14px}
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); font-size: 14px; }
    .signal-badge, .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; }
    .signal-badge.hot, .badge.hot, .badge-hot { background: var(--red-light); color: var(--red); }
    .signal-badge.cold, .badge.cold, .badge-cold { background: var(--accent-light); color: var(--accent); }
    .signal-badge.warm, .badge.warm { background: var(--orange-light); color: var(--orange); }
    .panel, .section { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
    .panel-header, .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid var(--border-light); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    thead th { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--accent); padding: 12px 14px; border-bottom: 2px solid var(--border); text-align: left; background: var(--bg); }
    tbody td { padding: 12px 14px; border-bottom: 1px solid var(--border-light); color: var(--text-primary); font-weight: 500; }
    tbody tr { transition: background 0.1s ease; }
    tbody tr:hover { background: var(--bg); }
    tbody tr:last-child td { border-bottom: none; }
    .three-pt-card, .tracker-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow-sm); }
    .quarter-box, .qtr-box { display: inline-flex; align-items: center; justify-content: center; min-width: 36px; height: 28px; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; background: var(--bg); color: var(--text-secondary); border: 1px solid var(--border-light); }
    .quarter-box.hot, .qtr-box.hot { background: var(--red-light); color: var(--red); border-color: transparent; }
    .thesis-card, .edge-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow-sm); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.2s ease; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--white); border-radius: var(--radius-lg); padding: 28px; width: 90%; max-width: 520px; box-shadow: var(--shadow-lg); animation: slideUp 0.25s ease; }
    .modal h2, .modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    input, select, textarea { font-family: 'Inter', sans-serif; font-size: 13px; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--white); color: var(--text-primary); transition: border-color 0.15s ease, box-shadow 0.15s ease; width: 100%; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    .bankroll-section, .bankroll-settings { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); margin-bottom: 20px; }
    .bankroll-section label, label { font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px; }
    .stop-loss, .rules-box, [style*="border-left: 3px solid"] { background: var(--orange-light) !important; border: 1px solid #fde68a !important; border-left: 3px solid var(--orange) !important; border-radius: var(--radius-sm) !important; padding: 12px 16px !important; color: #92400e !important; font-size: 13px !important; }
    .notification-toast, .toast { position: fixed; top: 20px; right: 20px; background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 20px; box-shadow: var(--shadow-lg); z-index: 2000; font-size: 13px; font-weight: 500; animation: slideIn 0.3s ease; max-width: 360px; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .auto-refresh-controls, .refresh-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); }
    .auto-refresh-controls select, .refresh-controls select { width: auto; min-width: 80px; }
    .game-score, .score { font-size: 20px; font-weight: 800; color: var(--text-primary); }
    .game-teams, .matchup, .teams { font-weight: 600; color: var(--text-primary); font-size: 14px; }
    .game-status, .status { font-size: 12px; color: var(--text-muted); font-weight: 500; }
    .signal-list, .signals { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    strong, b { font-weight: 700; }
    .remove-btn, button.remove, [onclick*="remove"] { background: var(--red-light) !important; color: var(--red) !important; border: none !important; border-radius: 6px !important; width: 32px !important; height: 32px !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; font-weight: 700 !important; font-size: 14px !important; padding: 0 !important; cursor: pointer; }
    .remove-btn:hover, button.remove:hover, [onclick*="remove"]:hover { background: var(--red) !important; color: white !important; }
  .tooltip-wrap{position:relative;display:inline-block;cursor:help}
.tooltip-wrap .info-dot{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:var(--border);color:var(--text-muted);font-size:9px;font-weight:700;margin-left:4px;vertical-align:middle}
.tooltip-wrap .tip{visibility:hidden;opacity:0;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1a1a2e;color:#e0e0e0;padding:8px 12px;border-radius:6px;font-size:11px;line-height:1.4;white-space:normal;width:220px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.3);pointer-events:none;transition:opacity .2s,visibility .2s}
.tooltip-wrap:hover .tip{visibility:visible;opacity:1}
.tooltip-wrap .tip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1a1a2e}
.mode-toggle{display:flex;align-items:center;gap:8px;background:var(--card-bg);border:1px solid var(--border);border-radius:20px;padding:4px 12px;cursor:pointer;transition:all .2s;user-select:none}
.mode-toggle:hover{border-color:var(--accent);box-shadow:var(--shadow-sm)}
.mode-toggle .mode-label{font-size:12px;font-weight:600;color:var(--text-muted);transition:all .2s}
.mode-toggle .mode-label.active-mode{color:var(--accent);font-weight:700}
.mode-switch{position:relative;width:36px;height:20px;background:var(--border);border-radius:10px;transition:all .3s}
.mode-switch::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:all .3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.mode-switch.ncaa{background:var(--accent)}
.mode-switch.ncaa::after{left:18px}
.ncaa-badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;background:#f59e0b;color:#fff;letter-spacing:.5px;margin-left:6px;vertical-align:middle}
.guide-section{padding:20px 0}
.guide-intro{color:var(--text-muted);font-size:13px;margin-bottom:16px;line-height:1.5}
.guide-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px}
.guide-card{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:16px;transition:all .2s}
.guide-card:hover{border-color:var(--accent);box-shadow:var(--shadow-sm)}
.guide-card h3{font-size:15px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.guide-card .edge-label{font-size:12px;color:var(--accent);font-weight:600;margin-bottom:6px}
.guide-card p{font-size:12px;color:var(--text-muted);line-height:1.5;margin-bottom:8px}
.guide-card .threshold{font-size:11px;color:var(--text-muted);background:var(--bg);padding:6px 10px;border-radius:6px;border-left:3px solid var(--accent)}
.signal-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.5px;color:#fff}
.signal-badge.badge-3pt{background:#3b82f6}
.signal-badge.badge-star{background:#f59e0b}
.signal-badge.badge-fragile{background:#ef4444}
.signal-badge.badge-paint{background:#10b981}
.signal-badge.badge-foul{background:#8b5cf6}
.signal-badge.badge-hustle{background:#f59e0b}
.signal-badge.badge-combined{background:#6366f1}
</style>
</head>
<body>

<div class="header">
  <div>
    <h1 id="main-title">NBA EDGE SYSTEM</h1>
    <div class="header-sub"><span id="main-subtitle">Live ML Edge Finder &bull; 3PT / Star Pace / Paint Durability / Fouls &bull; Auto-Updating</span></div>
  </div>
  <div class="header-right">
    <span class="conn-status conn-ok" id="connStatus" style="display:none;">Connected</span>
    <div>
      <span class="status-dot off" id="statusDot"></span>
      <div class="mode-toggle" onclick="switchMode()" id="mode-toggle" title="Switch between NBA and NCAA mode"><span class="mode-label active-mode" id="label-nba">NBA</span><div class="mode-switch" id="mode-switch"></div><span class="mode-label" id="label-ncaa">NCAA</span></div>
<span id="statusText" style="font-size:11px;">ESPN Feed</span>
    </div><button class="sound-toggle" id="soundToggle" onclick="toggleSound()" title="Toggle alert sounds">&#x1F50A; Sound</button><button class="demo-btn" onclick="runDemoScenario()" title="Simulate a live game scenario">&#x1F3AE; Demo</button>
  </div>
</div>

<div class="tab-bar">
  <div class="tab active" onclick="switchTab('live')" id="tab-live">Live Games <span class="badge" id="live-badge" style="display:none;">0</span></div>
  <div class="tab" onclick="switchTab('threept')" id="tab-threept">3PT Tracker <span class="badge badge-purple" id="threept-badge" style="display:none;">0</span></div>
  <div class="tab" onclick="switchTab('stars')" id="tab-stars">Star Tracker</div>
  <div class="tab" onclick="switchTab('log')" id="tab-log">Bet Log</div>
  <div class="tab" onclick="switchTab('bankroll')" id="tab-bankroll">Bankroll</div>
  <div class="tab" onclick="switchTab('guide')" id="tab-guide">Signal Guide</div>
</div>

<div class="container">
  <div id="quarter-alerts"></div>

  <!-- ==================== LIVE GAMES TAB ==================== -->
  <div class="tab-content active" id="content-live">
    <!-- EDGE THESIS PANEL -->
    <div class="edge-thesis-container" id="edgeThesisContainer">
      <div class="edge-thesis-header">
        <h2>LIVE EDGE OPPORTUNITIES</h2>
        <span class="thesis-count" id="thesisCount">0</span>
      </div>
      <div id="edgeThesisCards"></div>
    </div>

    <div class="auto-refresh-bar">
      <span class="dot" id="autoRefreshDot"></span>
      <span>Auto-refresh: <strong id="autoRefreshLabel">OFF</strong></span>
      <button class="btn btn-sm btn-green" id="autoRefreshBtn" onclick="toggleAutoRefresh()">Start</button>
      <span style="margin-left:6px;">Every:</span>
      <select id="refreshInterval" style="padding:2px 6px;font-size:11px;border-radius:4px;border:1px solid var(--border);" onchange="updateRefreshInterval()">
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
        <option value="120">2min</option>
      </select>
      <div class="countdown-bar"><div class="countdown-fill" id="countdownFill" style="width:100%;"></div></div>
      <span style="margin-left:auto;color:var(--gray);font-size:10px;">Last: <span id="live-last-update">-</span> | Errors: <span id="errorCount">0</span></span>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Live Games</div><div class="stat-value" id="live-games-count">-</div></div>
      <div class="stat-card"><div class="stat-label">3PT Signals <span class="tooltip-wrap" id="tpt-tooltip-wrap"><span class="info-dot">i</span><span class="tip">When a team shoots abnormally hot from 3PT (50%+ on 8+ attempts), regression to the mean is likely. Fade the hot-shooting team.</span></span></div><div class="stat-value orange" id="live-3pt-signals">0</div></div>
      <div class="stat-card"><div class="stat-label"><span id="star-label-text">Star Cold</span> <span class="tooltip-wrap" id="star-tooltip-wrap"><span class="info-dot">i</span><span class="tip">When a star player is cold (shooting well below average), their scoring tends to regress upward. The current line undervalues their team.</span></span></div><div class="stat-value orange" id="live-star-signals">0</div></div>
      <div class="stat-card"><div class="stat-label">Fragile Leads <span class="tooltip-wrap"><span class="info-dot">i</span><span class="tip">Leads built primarily on 3PT shooting (42%+ of points from 3) are structurally fragile. These leads collapse when shooting normalizes.</span></span></div><div class="stat-value teal" id="live-fragile-leads">0</div></div>
      <div class="stat-card"><div class="stat-label">Combined <span class="tooltip-wrap"><span class="info-dot">i</span><span class="tip">When multiple signals align (3PT regression + fragile lead + star cold), the edge compounds. 2+ signals = high confidence opportunity.</span></span></div><div class="stat-value red" id="live-combined-signals">0</div></div>
    </div>

    <div class="card">
      <div class="card-header"><span>Live Game Monitor</span>
        <button class="btn btn-green btn-sm" onclick="fetchESPNScoreboard()">Refresh Now</button>
      </div>
      <div class="card-body">
        <div class="games-grid" id="live-games-grid">
          <div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3C0;</div><p>Click "Refresh Now" or start auto-refresh to load live games.</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 3PT TRACKER TAB ==================== -->
  <div class="tab-content" id="content-threept">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Teams 50%+ 3PT</div><div class="stat-value red" id="threept-hot-count">0</div></div>
      <div class="stat-card"><div class="stat-label">Teams 45-50%</div><div class="stat-value orange" id="threept-warm-count">0</div></div>
      <div class="stat-card"><div class="stat-label">Qtr Alerts</div><div class="stat-value purple" id="threept-qtr-alerts">0</div></div>
      <div class="stat-card"><div class="stat-label">League Avg</div><div class="stat-value" style="color:var(--blue);" id="league-avg-value">36.5%</div></div>
    </div>
    <div class="card">
      <div class="card-header"><span>3-Point Shooting Tracker - Live</span><span style="font-size:10px;color:var(--gray);">Alert: 50%+ on 8+ att</span></div>
      <div class="card-body"><div class="games-grid" id="threept-grid"><div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3AF;</div><p>3PT tracking populates when live games run.</p></div></div></div>
    </div>
    <div class="card">
      <div class="card-header"><span>Quarter-End Alerts</span><button class="btn btn-sm btn-outline" onclick="clearQtrAlerts()">Clear</button></div>
      <div class="card-body">
        <table><thead><tr><th>Time</th><th>Team</th><th>Qtr</th><th>3PT%</th><th>Made/Att</th><th>Game</th><th>Action</th></tr></thead>
        <tbody id="qtr-alerts-body"><tr><td colspan="7" class="empty-state">No quarter-end alerts yet.</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- ==================== STAR TRACKER TAB ==================== -->
  <div class="tab-content" id="content-stars">
    <div class="card">
      <div class="card-header"><span>Star Player Database (23+ PPG)</span><span style="font-size:10px;color:var(--gray);">Signal: &lt;60% of expected pace</span></div>
      <div class="card-body" style="font-size:12px;">
        <p style="margin-bottom:10px;color:var(--gray);">Players tracked automatically in live games. Signal fires when scoring falls below 60% of expected pace. Tracks Q1 and halftime pace separately.</p>
        <table>
          <thead><tr><th>Player</th><th>Team</th><th>PPG</th><th>Q1 Exp</th><th>Half Exp</th><th>Signal (&lt;60%)</th><th></th></tr></thead>
          <tbody id="star-db-body"></tbody>
        </table>
        <div style="margin-top:10px;">
          <div class="form-grid" style="max-width:700px;">
            <div class="form-group"><label>Player Name</label><input type="text" id="add-star-name" placeholder="e.g., LeBron James" /></div>
            <div class="form-group"><label>Team</label><input type="text" id="add-star-team" placeholder="e.g., LAL" /></div>
            <div class="form-group"><label>PPG</label><input type="number" id="add-star-ppg" placeholder="e.g., 28.5" step="0.1" /></div>
            <div class="form-group" style="justify-content:flex-end;"><button class="btn btn-green" onclick="addStar()">Add</button></div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">Live Star Status</div>
      <div class="card-body">
        <table><thead><tr><th>Player</th><th>Game</th><th>Pts</th><th>Q1 Pace</th><th>Half Pace</th><th>Overall %</th><th>Period</th><th>Signal</th></tr></thead>
        <tbody id="live-star-status"><tr><td colspan="8" class="empty-state">Star stats populate when live games are running.</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- ==================== BET LOG TAB ==================== -->
  <div class="tab-content" id="content-log">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Total Bets</div><div class="stat-value" id="log-total">0</div></div>
      <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value" id="log-winrate">-</div></div>
      <div class="stat-card"><div class="stat-label">Net Units</div><div class="stat-value" id="log-net-units">0</div></div>
      <div class="stat-card"><div class="stat-label">ROI</div><div class="stat-value" id="log-roi">-</div></div>
      <div class="stat-card"><div class="stat-label">Streak</div><div class="stat-value" id="log-streak">-</div></div>
    </div>
    <div class="card">
      <div class="card-header"><span>All Bets</span><div><button class="btn btn-outline btn-sm" onclick="exportLog()">Export CSV</button> <button class="btn btn-red btn-sm" onclick="clearLog()">Clear All</button></div></div>
      <div class="card-body">
        <table><thead><tr><th>Date</th><th>Strategy</th><th>Game</th><th>Side</th><th>Line</th><th>Units</th><th>Result</th><th>Profit</th><th>Actions</th></tr></thead>
        <tbody id="bet-log-body"><tr><td colspan="9" class="empty-state">No bets logged yet.</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- ==================== BANKROLL TAB ==================== -->
  <div class="tab-content" id="content-bankroll">
    <div class="card">
      <div class="card-header">Bankroll Settings</div>
      <div class="card-body">
        <div class="form-grid" style="max-width:500px;">
          <div class="form-group"><label>Starting ($)</label><input type="number" id="bankroll-start" placeholder="1000" onchange="updateBankroll()" /></div>
          <div class="form-group"><label>Current ($)</label><input type="number" id="bankroll-current" placeholder="1050" onchange="updateBankroll()" /></div>
        </div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">1 Unit (1%)</div><div class="stat-value" id="br-unit">-</div></div>
      <div class="stat-card"><div class="stat-label">Max (2%)</div><div class="stat-value" id="br-max">-</div></div>
      <div class="stat-card"><div class="stat-label">Daily (5u)</div><div class="stat-value" id="br-daily">-</div></div>
      <div class="stat-card"><div class="stat-label">P/L</div><div class="stat-value" id="br-pl">-</div></div>
      <div class="stat-card"><div class="stat-label">P/L %</div><div class="stat-value" id="br-pl-pct">-</div></div>
    </div>
    <div class="card">
      <div class="card-header">Rules</div>
      <div class="card-body" style="font-size:13px;line-height:1.8;">
        <p><strong>Standard:</strong> 1u &bull; <strong>High conviction:</strong> 1.5u &bull; <strong>Max:</strong> 2u</p>
        <p style="margin-top:6px;padding:8px;background:#fff3cd;border-radius:6px;font-size:12px;"><strong>Stop-loss:</strong> 3 straight L = 1 day off. 20% drawdown = cut to 0.5% units.</p>
      </div>
    </div>
  </div>
</div>

<!-- LOG BET MODAL -->
<div class="modal-overlay" id="logModal">
  <div class="modal">
    <h3>Log This Bet</h3>
    <div class="form-grid">
      <div class="form-group"><label>Game</label><input type="text" id="modal-game" /></div>
      <div class="form-group"><label>Side</label><input type="text" id="modal-side" /></div>
      <div class="form-group"><label>Strategy</label><select id="modal-strategy"><option>Mean Reversion</option><option>3PT Regression</option><option>Paint Durability</option><option>Foul Trouble</option></select></div>
      <div class="form-group"><label>Line / Price</label><input type="text" id="modal-price" /></div>
      <div class="form-group"><label>Units</label><input type="number" id="modal-units" value="1" step="0.5" min="0.5" max="2" /></div>
      <div class="form-group"><label>Notes</label><input type="text" id="modal-notes" /></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-green" onclick="confirmLogBet()">Log Bet</button>
    </div>
  </div>
</div>


  <div id="scenario-alert-panel" class="scenario-alert-panel"></div>

  <div id="toast-container" style="position:fixed;top:70px;right:20px;z-index:150;display:flex;flex-direction:column;gap:6px;"></div>

<script>
let currentMode='nba';
const MODE_CONFIG={nba:{title:'NBA EDGE SYSTEM',subtitle:'Live ML Edge Finder \u2022 3PT / Star Pace / Paint Durability / Fouls \u2022 Auto-Updating',sport:'basketball/nba',starLabel:'Star Cold',starTooltip:'When a star player is cold (shooting well below average), their scoring tends to regress upward. The current line undervalues their team.',foulRateThreshold:6.5,foulTotalThreshold:10,foulPeriodMinutes:12},ncaa:{title:'NCAA EDGE SYSTEM',subtitle:'Live ML Edge Finder \u2022 3PT / Team Efficiency / Paint Durability / Fouls \u2022 College',sport:'basketball/mens-college-basketball',starLabel:'Team Slump',starTooltip:'When team offensive efficiency drops 15%+ below season average, regression to mean is likely. Markets overreact to cold stretches.',foulRateThreshold:5.0,foulTotalThreshold:7,foulPeriodMinutes:10}};
function switchMode(){currentMode=currentMode==='nba'?'ncaa':'nba';var cfg=MODE_CONFIG[currentMode];document.getElementById('main-title').textContent=cfg.title;document.getElementById('main-subtitle').textContent=cfg.subtitle;document.title=cfg.title.replace('SYSTEM','Dashboard');document.getElementById('star-label-text').textContent=cfg.starLabel;var tipEl=document.querySelector('#star-tooltip-wrap .tip');if(tipEl)tipEl.textContent=cfg.starTooltip;document.getElementById('mode-switch').className='mode-switch'+(currentMode==='ncaa'?' ncaa':'');document.getElementById('label-nba').className='mode-label'+(currentMode==='nba'?' active-mode':'');document.getElementById('label-ncaa').className='mode-label'+(currentMode==='ncaa'?' active-mode':'');var nbaG=document.getElementById('nba-guide');var ncaaG=document.getElementById('ncaa-guide');if(nbaG)nbaG.style.display=currentMode==='nba'?'':'none';if(ncaaG)ncaaG.style.display=currentMode==='ncaa'?'':'none';document.getElementById('league-avg-value').textContent=getLeague3PtAvg()+'%';}
function getESPNUrl(){return 'https://site.api.espn'+'.com/apis/site/v2/sports/'+MODE_CONFIG[currentMode].sport+'/scoreboard';}

// ==================== STAR DATABASE (23+ PPG) ====================
const DEFAULT_STARS = [
  { name: "Shai Gilgeous-Alexander", team: "OKC", ppg: 32.2 },
  { name: "Giannis Antetokounmpo", team: "MIL", ppg: 31.5 },
  { name: "Nikola Jokic", team: "DEN", ppg: 29.0 },
  { name: "Luka Doncic", team: "DAL", ppg: 28.1 },
  { name: "Jayson Tatum", team: "BOS", ppg: 27.8 },
  { name: "Joel Embiid", team: "PHI", ppg: 27.6 },
  { name: "Kevin Durant", team: "PHX", ppg: 27.3 },
  { name: "Devin Booker", team: "PHX", ppg: 27.2 },
  { name: "Anthony Edwards", team: "MIN", ppg: 27.0 },
  { name: "De'Aaron Fox", team: "SAC", ppg: 26.8 },
  { name: "Donovan Mitchell", team: "CLE", ppg: 26.5 },
  { name: "Jalen Brunson", team: "NYK", ppg: 26.3 },
  { name: "Anthony Davis", team: "LAL", ppg: 25.7 },
  { name: "Tyrese Maxey", team: "PHI", ppg: 25.5 },
  { name: "Karl-Anthony Towns", team: "NYK", ppg: 25.3 },
  { name: "Cade Cunningham", team: "DET", ppg: 24.8 },
  { name: "Trae Young", team: "ATL", ppg: 24.3 },
  { name: "Damian Lillard", team: "MIL", ppg: 24.0 },
  { name: "Jaylen Brown", team: "BOS", ppg: 23.8 },
  { name: "LeBron James", team: "LAL", ppg: 23.5 },
  { name: "Jaren Jackson Jr.", team: "MEM", ppg: 23.3 },
  { name: "Tyrese Haliburton", team: "IND", ppg: 23.2 },
  { name: "Zion Williamson", team: "NOP", ppg: 23.0 },
];

const TEAM_MAP = {
  'Atlanta Hawks':'ATL','Boston Celtics':'BOS','Brooklyn Nets':'BKN','Charlotte Hornets':'CHA',
  'Chicago Bulls':'CHI','Cleveland Cavaliers':'CLE','Dallas Mavericks':'DAL','Denver Nuggets':'DEN',
  'Detroit Pistons':'DET','Golden State Warriors':'GSW','Houston Rockets':'HOU','Indiana Pacers':'IND',
  'LA Clippers':'LAC','Los Angeles Clippers':'LAC','Los Angeles Lakers':'LAL','Memphis Grizzlies':'MEM',
  'Miami Heat':'MIA','Milwaukee Bucks':'MIL','Minnesota Timberwolves':'MIN','New Orleans Pelicans':'NOP',
  'New York Knicks':'NYK','Oklahoma City Thunder':'OKC','Orlando Magic':'ORL','Philadelphia 76ers':'PHI',
  'Phoenix Suns':'PHX','Portland Trail Blazers':'POR','Sacramento Kings':'SAC','San Antonio Spurs':'SAS',
  'Toronto Raptors':'TOR','Utah Jazz':'UTA','Washington Wizards':'WAS',
};
function shortName(n) { return TEAM_MAP[n] || n.split(' ').pop().substring(0,3).toUpperCase(); }

// ==================== STATE ====================
let state = {
  betLog: JSON.parse(localStorage.getItem('betLog') || '[]'),
  bankroll: JSON.parse(localStorage.getItem('bankroll') || '{"start":0,"current":0}'),
  stars: JSON.parse(localStorage.getItem('starPlayers') || 'null') || DEFAULT_STARS,
  autoRefresh: false, refreshTimer: null, countdownTimer: null,
  quarterAlerts: JSON.parse(localStorage.getItem('quarterAlerts') || '[]'),
  lastKnownPeriods: {}, prevTeamData: {},
  errorCount: 0, consecutiveErrors: 0,
};

// ==================== INIT ====================
document.getElementById('bankroll-start').value = state.bankroll.start || '';
document.getElementById('bankroll-current').value = state.bankroll.current || '';
updateBankroll(); renderBetLog(); renderStarDB(); renderQtrAlerts();

// ==================== TABS ====================
function switchTab(t) {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  document.getElementById('content-'+t).classList.add('active');
}

// ==================== AUTO REFRESH ====================
function toggleAutoRefresh() {
  state.autoRefresh = !state.autoRefresh;
  const btn = document.getElementById('autoRefreshBtn'), dot = document.getElementById('autoRefreshDot'), lbl = document.getElementById('autoRefreshLabel');
  if (state.autoRefresh) {
    btn.textContent = 'Stop'; btn.className = 'btn btn-sm btn-red'; dot.className = 'dot'; lbl.textContent = 'ON';
    fetchESPNScoreboard(); startCountdown();
  } else {
    btn.textContent = 'Start'; btn.className = 'btn btn-sm btn-green'; dot.className = 'dot off'; lbl.textContent = 'OFF';
    clearInterval(state.refreshTimer); clearInterval(state.countdownTimer);
    document.getElementById('countdownFill').style.width = '100%';
  }
}
function startCountdown() {
  const iv = parseInt(document.getElementById('refreshInterval').value) * 1000;
  let rem = iv;
  clearInterval(state.refreshTimer); clearInterval(state.countdownTimer);
  state.refreshTimer = setInterval(() => { if (state.autoRefresh) { fetchESPNScoreboard(); rem = iv; } }, iv);
  state.countdownTimer = setInterval(() => { rem -= 1000; document.getElementById('countdownFill').style.width = Math.max(0, rem/iv*100)+'%'; }, 1000);
}
function updateRefreshInterval() { if (state.autoRefresh) startCountdown(); }

// ==================== PACE HELPERS ====================
function getQ1Expected(ppg) { return ppg * 0.25; }
function getHalfExpected(ppg) { return ppg * 0.5; }
function getExpectedByTime(ppg, mins) { return ppg * (mins / 48); }

// ==================== CONNECTION STATUS ====================
function setConnStatus(status) {
  const el = document.getElementById('connStatus');
  const dot = document.getElementById('statusDot');
  el.style.display = 'inline';
  if (status === 'ok') { el.textContent = 'Connected'; el.className = 'conn-status conn-ok'; dot.className = 'status-dot live'; state.consecutiveErrors = 0; }
  else if (status === 'error') { el.textContent = 'Error'; el.className = 'conn-status conn-err'; dot.className = 'status-dot error'; state.consecutiveErrors++; state.errorCount++; }
  else { el.textContent = 'Loading...'; el.className = 'conn-status conn-loading'; }
  document.getElementById('errorCount').textContent = state.errorCount;
}

// ==================== QUARTER-END DETECTION ====================
function checkQuarterEnd(gameId, teamAbbr, currentPeriod, pct, made, att, gameLabel) {
  const key = `${gameId}_${teamAbbr}`;
  const prev = state.lastKnownPeriods[key] || 0;
  if (currentPeriod > prev && prev > 0) {
    const p = state.prevTeamData[key];
    if (p) {
      const qM = (parseInt(made)||0) - (p.made||0), qA = (parseInt(att)||0) - (p.att||0);
      const qP = qA > 0 ? (qM/qA*100) : 0;
      if (qP >= 50 && qA >= 4) {
        const a = { id: Date.now()+Math.random(), time: new Date().toLocaleTimeString(), team: teamAbbr, quarter: prev, pct: qP.toFixed(1), made: qM, att: qA, game: gameLabel };
        state.quarterAlerts.unshift(a); localStorage.setItem('quarterAlerts', JSON.stringify(state.quarterAlerts));
        renderQtrAlerts(); showQuarterToast(a);
      }
    }
  }
  state.lastKnownPeriods[key] = currentPeriod;
  state.prevTeamData[key] = { made: parseInt(made)||0, att: parseInt(att)||0, period: currentPeriod };
}

function showQuarterToast(a) {
  const c = document.getElementById('toast-container'), t = document.createElement('div');
  t.className = 'quarter-alert-toast';
  t.innerHTML = `<div class="toast-title">Q${a.quarter} END - ${a.team}</div><div class="toast-body">${a.team} shot ${a.pct}% from 3 (${a.made}/${a.att}) in Q${a.quarter}! ${a.game}</div>`;
  t.onclick = () => t.remove(); c.appendChild(t);
  setTimeout(() => { if (t.parentNode) t.remove(); }, 11000);
  const badge = document.getElementById('threept-badge');
  if (state.quarterAlerts.length > 0) { badge.style.display = 'inline'; badge.textContent = state.quarterAlerts.length; }
}

function renderQtrAlerts() {
  const tb = document.getElementById('qtr-alerts-body');
  if (!state.quarterAlerts.length) { tb.innerHTML = '<tr><td colspan="7" class="empty-state">No quarter-end alerts yet.</td></tr>'; document.getElementById('threept-qtr-alerts').textContent = '0'; return; }
  tb.innerHTML = state.quarterAlerts.map(a => `<tr><td>${a.time}</td><td><strong>${a.team}</strong></td><td>Q${a.quarter}</td><td style="color:var(--red);font-weight:800;">${a.pct}%</td><td>${a.made}/${a.att}</td><td>${a.game}</td><td><button class="btn btn-purple btn-sm" onclick="openLogModal('${a.game}','3PT Q${a.quarter}','3PT Regression')">Log</button></td></tr>`).join('');
  document.getElementById('threept-qtr-alerts').textContent = state.quarterAlerts.length;
}
function clearQtrAlerts() { if(confirm('Clear all?')) { state.quarterAlerts=[]; localStorage.setItem('quarterAlerts','[]'); renderQtrAlerts(); document.getElementById('threept-badge').style.display='none'; } }

// ==================== LEAD DURABILITY (PAINT vs 3PT) ====================
function analyzeScoringDurability(teamAbbr, score, fg3Made, opponentScore) {
  const s = parseInt(score) || 0;
  const m3 = parseInt(fg3Made) || 0;
  if (s <= 0) return { pct3: 0, durability: 'neutral', label: '-', fragile: false };
  const pts3 = m3 * 3;
  const pct3 = (pts3 / s * 100);
  const nonThreePts = s - pts3;
  // League average: ~35% of points come from 3PT. Above 42% is fragile, below 28% is durable
  const isLeading = s > (parseInt(opponentScore) || 0);
  const fragile = pct3 >= getFragile3PtThreshold() && isLeading && s >= 20;
  const durable = pct3 <= 28 && isLeading && s >= 20;
  let label = `${pct3.toFixed(0)}% from 3`;
  let durability = 'neutral';
  if (fragile) { durability = 'fragile'; label = `${pct3.toFixed(0)}% from 3 - FRAGILE lead`; }
  else if (durable) { durability = 'durable'; label = `${pct3.toFixed(0)}% from 3 - DURABLE lead`; }
  return { pct3, durability, label, fragile, durable, pts3, nonThreePts };
}

// ==================== FOUL TRACKING ====================
function analyzeReboundEffort(aOREB, hOREB, aDREB, hDREB, aScore, hScore) {
      const aOreb = parseInt(aOREB)||0, hOreb = parseInt(hOREB)||0;
      const aDreb = parseInt(aDREB)||0, hDreb = parseInt(hDREB)||0;
      const diff = aOreb - hOreb;
      const totalOreb = aOreb + hOreb;
      const scoreDiff = (parseInt(hScore)||0) - (parseInt(aScore)||0);
      return { aOreb, hOreb, aDreb, hDreb, diff, totalOreb, scoreDiff };
    }

    function analyzeTeamFouls(fouls, period, clock) {
  const f = parseInt(fouls) || 0;
  const clockMin = parseFloat(clock?.split(':')[0] || 12);
  const minsPlayed = (period - 1) * 12 + (12 - clockMin);
  const foulRate = minsPlayed > 0 ? (f / minsPlayed * 12) : 0; // fouls per quarter rate
  // NBA average: ~5 fouls per quarter. High foul rate = bonus free throws = inflated scoring
  const extremeFouls = foulRate >= 8.0 && f >= 14;
      const highFouls = !extremeFouls && foulRate >= 6.5 && f >= 10;
  return { fouls: f, foulRate: foulRate.toFixed(1), highFouls, extremeFouls, perQtr: foulRate.toFixed(1) };
}

// ==================== ESPN SCOREBOARD ====================

function getLeague3PtAvg() { return currentMode === 'nba' ? 36.5 : 33.4; }
function getFragile3PtThreshold() { return currentMode === 'nba' ? 42 : 38; }
function getLeagueName() { return currentMode === 'nba' ? 'NBA' : 'NCAA'; }

async function fetchESPNScoreboard() {
  const grid = document.getElementById('live-games-grid');
  const tpGrid = document.getElementById('threept-grid');
  setConnStatus('loading');

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    const res = await fetch(getESPNUrl(), { signal: controller.signal });
    clearTimeout(timeout);
    if (!res.ok) throw new Error('ESPN ' + res.status);
    const data = await res.json();
    setConnStatus('ok');
    const events = data.events || [];
    document.getElementById('live-last-update').textContent = new Date().toLocaleTimeString();

    const liveEvents = events.filter(e => { const s = e.status?.type?.state; return s === 'in' || s === 'pre'; });
    const inProgress = events.filter(e => e.status?.type?.state === 'in');
    document.getElementById('live-games-count').textContent = inProgress.length;

    if (liveEvents.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3C0;</div><p>No live or upcoming NBA games right now.</p></div>`;
      tpGrid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3AF;</div><p>No live games.</p></div>`;
      document.getElementById('edgeThesisContainer').classList.remove('active');
      return;
    }

    let sig3=0, sigStar=0, sigCombined=0, sigFragile=0, hotTeams=0, warmTeams=0;
    let cards='', tpCards='', gameTheses=[];

    for (const event of liveEvents) {
      const comp = event.competitions?.[0]; if (!comp) continue;
      const away = comp.competitors?.find(c => c.homeAway==='away');
      const home = comp.competitors?.find(c => c.homeAway==='home');
      if (!away || !home) continue;

      const gid = event.id;
      const aA = away.team?.abbreviation || shortName(away.team?.displayName||'');
      const hA = home.team?.abbreviation || shortName(home.team?.displayName||'');
      const aS = parseInt(away.score)||0, hS = parseInt(home.score)||0;
      const isLive = event.status?.type?.state === 'in';
      const per = event.status?.period||0, clk = event.status?.displayClock||'';
      const detail = event.status?.type?.shortDetail||'';
      const gLabel = `${aA} @ ${hA}`;
      const aRec = away.records?.[0]?.summary||'', hRec = home.records?.[0]?.summary||'';

      let aStats={}, hStats={};
      (away.statistics||[]).forEach(s => { aStats[s.name]=s.displayValue; });
      (home.statistics||[]).forEach(s => { hStats[s.name]=s.displayValue; });

      let a3P=aStats.threePointFieldGoalPct||aStats.threePointPct||'-';
      let h3P=hStats.threePointFieldGoalPct||hStats.threePointPct||'-';
      let a3M=aStats.threePointFieldGoalsMade||'-', a3A=aStats.threePointFieldGoalsAttempted||'-';
      let h3M=hStats.threePointFieldGoalsMade||'-', h3A=hStats.threePointFieldGoalsAttempted||'-';
      let aFouls=aStats.fouls||aStats.totalFouls||'0', hFouls=hStats.fouls||hStats.totalFouls||'0';

      if (isLive) { checkQuarterEnd(gid, aA, per, a3P, a3M, a3A, gLabel); checkQuarterEnd(gid, hA, per, h3P, h3M, h3A, gLabel); }

      let aLeaders=[], hLeaders=[];
      (comp.competitors||[]).forEach(c => {
        (c.leaders||[]).forEach(cat => {
          if (cat.name==='points'||cat.displayName==='Points') {
            (cat.leaders||[]).forEach(l => {
              const e = { name: l.athlete?.shortName||l.athlete?.displayName||'?', pts: parseFloat(l.value)||0, team: c.homeAway==='away'?aA:hA };
              if (c.homeAway==='away') aLeaders.push(e); else hLeaders.push(e);
            });
          }
        });
      });

      let signals=[], signalLevel=0;
      let thesis = { game: gLabel, aTeam: aA, hTeam: hA, aScore: aS, hScore: hS, per, clk, detail, criteria: {}, betSide: '', betLogic: '', signals: [] };

      if (isLive) {
        // 3PT CHECK
        const chk3 = (p,m,a,t,side) => {
          const pn=parseFloat(p), an=parseInt(a), mn=parseInt(m);
          if (pn>=50&&an>=8) {
            signals.push({type:'3pt',text:`${t} ${pn.toFixed(0)}% from 3 (${mn}/${an}) - UNSUSTAINABLE`,level:2});
            sig3++;
                  fire3PTAlert(t, pn.toFixed(0), mn, an, gLabel, per, clk); hotTeams++;
            thesis.criteria[`3pt_${side}`] = {met:true, strong:true, label:`${t} 3PT: ${pn.toFixed(0)}% (${mn}/${an})`, detail:`${getLeagueName()} avg is ${getLeague3PtAvg()}%. Shooting ${pn.toFixed(0)}% on ${an} attempts is 2+ std deviations above mean. This rate will regress &mdash; teams shooting 50%+ from 3 in a half sustain it only ~12% of games. The lead they built on 3PT scoring is inflated.`, value:`${pn.toFixed(0)}% on ${an} att`};
            return true;
          } else if (pn>=45&&an>=10) {
            signals.push({type:'3pt',text:`${t} ${pn.toFixed(0)}% from 3 (${mn}/${an}) - elevated`,level:1});
            warmTeams++;
            thesis.criteria[`3pt_${side}`] = {met:true, strong:false, label:`${t} 3PT: ${pn.toFixed(0)}% (${mn}/${an})`, detail:`Elevated but not extreme. Watch for further increase.`, value:`${pn.toFixed(0)}% on ${an} att`, warn:true};
          } else {
            thesis.criteria[`3pt_${side}`] = {met:false, label:`${t} 3PT: ${pn?pn.toFixed(0):'0'}%`, detail:`Normal shooting range, no 3PT regression signal.`, value:'Normal'};
          }
          return false;
        };
        const a3Hot = chk3(a3P,a3M,a3A,aA,'away'), h3Hot = chk3(h3P,h3M,h3A,hA,'home');

        // STAR PACE CHECK (60% threshold)
        const cM = parseFloat(clk?.split(':')[0]||12), cS = parseFloat(clk?.split(':')[1]||0);
        const gMins = (per-1)*12 + (12-cM-cS/60), gPct = Math.min(gMins/48,1);
        let starColdTeams = {};
        [...aLeaders,...hLeaders].forEach(leader => {
          const star = state.stars.find(s => leader.name.toLowerCase().includes(s.name.split(' ').pop().toLowerCase()) && s.team===leader.team);
          if (star) {
            const exp = getExpectedByTime(star.ppg, gMins);
            const pr = exp>0 ? leader.pts/exp : 1;
            const side = leader.team===aA?'away':'home';
            const oppSide = side==='away'?'home':'away';
            if (pr<0.6 && gPct>=0.2 && per<=3) {
              let ctx = per===1?` Q1 exp: ${getQ1Expected(star.ppg).toFixed(0)}`:per===2?` Half exp: ${getHalfExpected(star.ppg).toFixed(0)}`:'';
              signals.push({type:'star',text:`${leader.name} ${leader.pts}pts (exp ~${exp.toFixed(0)}, threshold ${(exp*0.6).toFixed(0)}).${ctx} MR candidate.`,level:2});
              sigStar++;
                fireStarColdAlert(leader, star, gMins, per, clk, gLabel, pr);
              starColdTeams[leader.team] = leader.name;
              thesis.criteria[`star_${oppSide}`] = {met:true, strong:true, label:`Opponent Star Cold: ${leader.name}`, detail:`${leader.name} averages ${star.ppg} PPG. At Q${per} ${clk}, expected ~${exp.toFixed(0)} pts but only has ${leader.pts}. That's ${(pr*100).toFixed(0)}% of pace (<60% threshold). Stars at this pace typically score 4-8 pts above current rate by game end &mdash; the market hasn't priced this bounce-back yet. Live ML is too favorable to the OTHER side.`, value:`${leader.pts}/${exp.toFixed(0)} pts (${(pr*100).toFixed(0)}%)`};
            } else if (pr<0.75 && gPct>=0.2) {
              signals.push({type:'star',text:`${leader.name} ${leader.pts}pts, behind ${star.ppg} PPG pace (exp ~${exp.toFixed(0)})`,level:1});
              thesis.criteria[`star_${oppSide}`] = {met:true, strong:false, label:`Opponent Star Below Pace: ${leader.name}`, detail:`${leader.name} (${star.ppg} PPG) has ${leader.pts} pts vs ${exp.toFixed(0)} expected. Below pace but not at critical 60% threshold yet.`, value:`${(pr*100).toFixed(0)}% pace`, warn:true};
            }
          }
        });

        // LEAD DURABILITY (PAINT vs 3PT)
        const aDur = analyzeScoringDurability(aA, aS, a3M, hS);
        const hDur = analyzeScoringDurability(hA, hS, h3M, aS);
        if (aDur.fragile) {
          signals.push({type:'paint',text:`${aA} lead built on 3PT (${aDur.pct3.toFixed(0)}% of pts from 3). Fragile - expect regression.`,level:2});
          sigFragile++;
          thesis.criteria['paint_away'] = {met:true, strong:true, label:`${aA} Lead Built on 3PT`, detail:`${aDur.pct3.toFixed(0)}% of ${aA}'s scoring is from 3-pointers (threshold: 42%). Leads built on 3PT shooting are fragile because 3PT% regresses toward ${getLeague3PtAvg()}%. If those 3s stop falling, their lead evaporates. Paint-heavy scoring is far more sustainable &mdash; paint points convert at ~60% vs 3PT at ~36%.`, value:`${aDur.pct3.toFixed(0)}% from 3PT`};
        } else {
          thesis.criteria['paint_away'] = {met:false, label:`${aA} Scoring Balance`, detail:`${aA} scoring is balanced or paint-heavy. Lead is durable.`, value: aS>0?`${aDur.pct3.toFixed(0)}% from 3PT`:'N/A'};
        }
        if (hDur.fragile) {
          signals.push({type:'paint',text:`${hA} lead built on 3PT (${hDur.pct3.toFixed(0)}% of pts from 3). Fragile - expect regression.`,level:2});
          sigFragile++;
          thesis.criteria['paint_home'] = {met:true, strong:true, label:`${hA} Lead Built on 3PT`, detail:`${hDur.pct3.toFixed(0)}% of ${hA}'s scoring is from 3-pointers (threshold: 42%). Same logic &mdash; 3PT-dependent leads are fragile. Market often overweights the current scoreboard without considering HOW the points were scored.`, value:`${hDur.pct3.toFixed(0)}% from 3PT`};
        } else {
          thesis.criteria['paint_home'] = {met:false, label:`${hA} Scoring Balance`, detail:`${hA} scoring is balanced or paint-heavy. Lead is durable.`, value: hS>0?`${hDur.pct3.toFixed(0)}% from 3PT`:'N/A'};
        }

        // REBOUND DATA (from summary endpoint)
        let aOREB = 0, hOREB = 0, aDREB = 0, hDREB = 0;
        try {
          const sumUrl = 'https://site.api.espn.com/apis/site/v2/sports/basketball/' + (currentMode === 'nba' ? 'nba' : 'mens-college-basketball') + '/summary?event=' + gid;
          const sumRes = await fetch(sumUrl, { signal: AbortSignal.timeout(5000) });
          if (sumRes.ok) {
            const sumData = await sumRes.json();
            const boxTeams = sumData.boxscore?.teams || [];
            for (const bt of boxTeams) {
              const isHome = bt.homeAway === 'home';
              const stats = bt.statistics || [];
              for (const cat of stats) {
                if (cat.name === 'offensiveRebounds') { if (isHome) hOREB = parseInt(cat.displayValue)||0; else aOREB = parseInt(cat.displayValue)||0; }
                if (cat.name === 'defensiveRebounds') { if (isHome) hDREB = parseInt(cat.displayValue)||0; else aDREB = parseInt(cat.displayValue)||0; }
              }
            }
          }
        } catch(e) { /* summary fetch failed, OREB signals won\'t fire */ }

        // FOUL ANALYSIS
        const aFoul = analyzeTeamFouls(aFouls, per, clk);
        const hFoul = analyzeTeamFouls(hFouls, per, clk);
        if (aFoul.extremeFouls) {
        signals.push({type:'foul',text:`${aA} EXTREME foul rate (${aFoul.fouls} fouls, ${aFoul.perQtr}/qtr). Bonus FTs inflating score.`,level:2});
        thesis.criteria['foul_away'] = {met:true, strong:true, label:`${aA} Extreme Foul Rate`, detail:`${aA} fouling at extreme rate ${aFoul.perQtr}/qtr (${aFoul.fouls} total). Opponent FT inflation will regress.`, value:`${aFoul.perQtr}/qtr`};
      } else if (aFoul.highFouls) {
          signals.push({type:'foul',text:`${aA} high foul rate (${aFoul.fouls} fouls, ${aFoul.perQtr}/qtr). Opponent getting bonus FTs - inflated scoring.`,level:1});
          thesis.criteria['foul_away'] = {met:true, strong:false, label:`${aA} High Foul Rate`, detail:`${aA} fouling at ${aFoul.perQtr}/qtr (${aFoul.fouls} total). This sends ${hA} to the FT line more &mdash; inflating ${hA}'s score with easy points. But fouls regress as coaches adjust. ${hA}'s lead may be partly built on FT volume that won't sustain.`, value:`${aFoul.perQtr}/qtr`, warn:true};
        }
        if (hFoul.extremeFouls) {
        signals.push({type:'foul',text:`${hA} EXTREME foul rate (${hFoul.fouls} fouls, ${hFoul.perQtr}/qtr). Bonus FTs inflating score.`,level:2});
        thesis.criteria['foul_home'] = {met:true, strong:true, label:`${hA} Extreme Foul Rate`, detail:`${hA} fouling at extreme rate ${hFoul.perQtr}/qtr (${hFoul.fouls} total). Opponent FT inflation will regress.`, value:`${hFoul.perQtr}/qtr`};
      } else if (hFoul.highFouls) {
          signals.push({type:'foul',text:`${hA} high foul rate (${hFoul.fouls} fouls, ${hFoul.perQtr}/qtr). Opponent getting bonus FTs - inflated scoring.`,level:1});
          thesis.criteria['foul_home'] = {met:true, strong:false, label:`${hA} High Foul Rate`, detail:`${hA} fouling at ${hFoul.perQtr}/qtr (${hFoul.fouls} total). ${aA} getting bonus FT trips that inflate their scoring. Foul rates typically normalize as game progresses.`, value:`${hFoul.perQtr}/qtr`, warn:true};
        }

        // HUSTLE EDGE - Offensive Rebound Dominance
        const reb = analyzeReboundEffort(aOREB, hOREB, aDREB, hDREB, aS, hS);
        if (reb.totalOreb >= 6) {
          if (reb.diff >= 4 && reb.scoreDiff > 0) {
            signals.push({type:'hustle',text:`${aA} out-hustling on offensive boards (${reb.aOreb} OREB vs ${reb.hOreb}). +${reb.diff} extra possessions while trailing by ${reb.scoreDiff}.`,level:1});
            thesis.criteria['hustle_away'] = {met:true, strong:false, label:`${aA} OREB Dominance`, detail:`${aA} has ${reb.aOreb} offensive rebounds vs ${reb.hOreb} for ${hA}. Each OREB is ~1.1 pts of extra value. Effort advantage persists.`, value:'+' + reb.diff + ' OREB'};
          }
          if (reb.diff <= -4 && reb.scoreDiff < 0) {
            signals.push({type:'hustle',text:`${hA} out-hustling on offensive boards (${reb.hOreb} OREB vs ${reb.aOreb}). +${Math.abs(reb.diff)} extra possessions while trailing by ${Math.abs(reb.scoreDiff)}.`,level:1});
            thesis.criteria['hustle_home'] = {met:true, strong:false, label:`${hA} OREB Dominance`, detail:`${hA} has ${reb.hOreb} offensive rebounds vs ${reb.aOreb} for ${aA}. Each OREB is ~1.1 pts of extra value. Effort advantage persists.`, value:'+' + Math.abs(reb.diff) + ' OREB'};
          }
        }

        // COMBINED - build thesis per side
        const has3=signals.some(s=>s.type==='3pt'&&s.level===2);
        const hasStar=signals.some(s=>s.type==='star'&&s.level===2);
        const hasPaint=signals.some(s=>s.type==='paint'&&s.level===2);
        const hasFragile=signals.some(s=>s.type==='fragile'&&s.level>=2);
        const hasFoul=signals.some(s=>s.type==='foul'&&s.level>=1);
        const hasHustle=signals.some(s=>s.type==='hustle'&&s.level>=1);
        if ((has3&&hasStar)||(has3&&hasPaint)||(has3&&hasFoul)||(has3&&hasHustle)||(hasStar&&hasPaint)||(hasStar&&hasFragile)||(hasStar&&hasFoul)||(hasStar&&hasHustle)||(hasPaint&&hasFragile)||(hasPaint&&hasFoul)||(hasFragile&&hasFoul)||(hasFragile&&hasHustle)||(hasFoul&&hasHustle)) { signalLevel=2; sigCombined++; }
        else if (has3||hasStar||hasPaint||hasFragile||hasFoul||hasHustle) signalLevel=1;

        // Determine bet side and build thesis logic
        if (signalLevel >= 2) {
          // Figure out which team to bet ON (the one that benefits from regression)
          let betTeam = '', fadeTeam = '', reasons = [];
          const a3Data = thesis.criteria['3pt_away'], h3Data = thesis.criteria['3pt_home'];
          const aPaint = thesis.criteria['paint_away'], hPaint = thesis.criteria['paint_home'];

          // Score each side: who has unsustainable advantages?
          let awayFade=0, homeFade=0;
          if (a3Data?.met && a3Data?.strong) awayFade++;  // away shooting too hot = fade away
          if (h3Data?.met && h3Data?.strong) homeFade++;  // home shooting too hot = fade home
          if (aPaint?.met && aPaint?.strong && aS > hS) awayFade++;  // away lead is fragile
          if (hPaint?.met && hPaint?.strong && hS > aS) homeFade++;  // home lead is fragile
          // Star cold on a team = bet ON that team (star will regress up)
          if (starColdTeams[aA]) homeFade++;  // away star cold = away bounces back = fade home
          if (starColdTeams[hA]) awayFade++;  // home star cold = home bounces back = fade away

          if (awayFade > homeFade) { betTeam = hA; fadeTeam = aA; }
          else if (homeFade > awayFade) { betTeam = aA; fadeTeam = hA; }
          else if (awayFade > 0) { betTeam = hA; fadeTeam = aA; }
          else { betTeam = aS < hS ? aA : hA; fadeTeam = aS < hS ? hA : aA; }

          // Build the narrative
          if (a3Data?.met && a3Data?.strong) reasons.push(`${aA} is shooting an unsustainable ${a3Data.value} from 3 &mdash; this will cool off`);
          if (h3Data?.met && h3Data?.strong) reasons.push(`${hA} is shooting an unsustainable ${h3Data.value} from 3 &mdash; this will cool off`);
          if (starColdTeams[aA]) reasons.push(`${starColdTeams[aA]} (${aA}) is ice cold &mdash; star players at <60% pace bounce back ~78% of the time`);
          if (starColdTeams[hA]) reasons.push(`${starColdTeams[hA]} (${hA}) is ice cold &mdash; star players at <60% pace bounce back ~78% of the time`);
          if (aPaint?.met && aPaint?.strong && aS > hS) reasons.push(`${aA}'s lead is fragile &mdash; ${aPaint.value} scoring from 3PT`);
          if (hPaint?.met && hPaint?.strong && hS > aS) reasons.push(`${hA}'s lead is fragile &mdash; ${hPaint.value} scoring from 3PT`);
          if (thesis.criteria['foul_away']?.met) reasons.push(`${aA} fouling heavy (${thesis.criteria['foul_away'].value}) &mdash; opponent FT inflation`);
          if (thesis.criteria['foul_home']?.met) reasons.push(`${hA} fouling heavy (${thesis.criteria['foul_home'].value}) &mdash; opponent FT inflation`);

          const strongCriteria = Object.values(thesis.criteria).filter(c => c.met && c.strong).length;
          const allCriteria = Object.values(thesis.criteria).filter(c => c.met).length;

          thesis.betSide = betTeam;
          thesis.fadeSide = fadeTeam;
          thesis.betLogic = reasons.join('. ') + '.';
          thesis.confidence = strongCriteria >= 3 ? 'high' : strongCriteria >= 2 ? 'high' : allCriteria >= 2 ? 'medium' : 'low';
          thesis.strongCount = strongCriteria;
          thesis.totalMet = allCriteria;
          thesis.signals = signals;
          thesis.signalLevel = signalLevel;
          gameTheses.push(thesis);
        }
      }

      const cc = signalLevel===2?'signal-fire':signalLevel===1?'signal-warn':'';
      const hc = isLive?'game-card-header live-pulse':'game-card-header';

      const bar3 = (p,m,a,t) => {
        const v=parseFloat(p)||0, bc=v>=50?'hot':v>=getLeague3PtAvg()?'normal':'cold';
        return `<div class="stat-bar-row"><span class="stat-bar-label">${t} 3PT%</span><div class="stat-bar-track"><div class="stat-bar-fill ${bc}" style="width:${Math.min(v,100)}%">${v.toFixed(0)}%</div><div class="stat-bar-avg" style="left:${getLeague3PtAvg()}%" data-label="${getLeague3PtAvg()}%"></div></div><span class="stat-bar-value">${m||'-'}/${a||'-'}</span></div>`;
      };

      // Durability bars
      let durabilityHTML = '';
      if (isLive && (aS > 0 || hS > 0)) {
        const aDur = analyzeScoringDurability(aA, aS, a3M, hS);
        const hDur = analyzeScoringDurability(hA, hS, h3M, aS);
        const durBar = (team, dur) => {
          if (dur.pct3 <= 0) return '';
          const cls = dur.durability;
          const w = Math.min(dur.pct3, 100);
          const col = dur.fragile ? 'var(--red)' : dur.durable ? 'var(--teal)' : 'var(--blue)';
          return `<div class="durability-bar ${cls}"><span>${team}</span><div class="durability-meter"><div class="durability-meter-fill" style="width:${w}%;background:${col};"></div></div><span>${dur.label}</span></div>`;
        };
        durabilityHTML = durBar(aA, aDur) + durBar(hA, hDur);
      }

      // Foul info
      let foulHTML = '';
      if (isLive) {
        const aF = analyzeTeamFouls(aFouls, per, clk);
        const hF = analyzeTeamFouls(hFouls, per, clk);
        if (parseInt(aFouls) > 0 || parseInt(hFouls) > 0) {
          foulHTML = `<div class="stat-bar-row"><span class="stat-bar-label">Fouls</span><span style="flex:1;font-size:11px;">${aA}: ${aFouls}${aF.highFouls?' &#x26A0;':''} | ${hA}: ${hFouls}${hF.highFouls?' &#x26A0;':''}</span></div>`;
        }
      }

      cards += `<div class="game-card ${cc}"><div class="${hc}"><span>${isLive?'LIVE':'UPCOMING'} ${detail}</span><span>${new Date(event.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>
        <div class="game-card-body">
          <div class="game-teams"><div class="team-block"><div class="team-name">${aA}</div><div class="team-record">${aRec}</div><div class="team-score">${isLive?aS:'-'}</div></div><div class="vs-block"><div class="vs-text">@</div>${isLive?`<div class="game-period">Q${per} ${clk}</div>`:''}</div><div class="team-block"><div class="team-name">${hA}</div><div class="team-record">${hRec}</div><div class="team-score">${isLive?hS:'-'}</div></div></div>
          ${isLive?`<div class="stat-bars">${bar3(a3P,a3M,a3A,aA)}${bar3(h3P,h3M,h3A,hA)}${foulHTML}${aLeaders.length?`<div class="stat-bar-row"><span class="stat-bar-label">${aA} pts</span><span style="flex:1;font-weight:700;font-size:11px;">${aLeaders[0]?.name}: ${aLeaders[0]?.pts}</span></div>`:''}${hLeaders.length?`<div class="stat-bar-row"><span class="stat-bar-label">${hA} pts</span><span style="flex:1;font-weight:700;font-size:11px;">${hLeaders[0]?.name}: ${hLeaders[0]?.pts}</span></div>`:''}</div>${durabilityHTML}`:''}
          ${signals.length?`<div class="signal-panel ${signalLevel===2?'fire':signalLevel===1?'strong':''}"><div class="signal-title ${signalLevel===2?'fire':'warn'}">${signalLevel===2?'STRONG EDGE SIGNAL':'DEVELOPING SIGNAL'}</div>${signals.map(s=>`<div class="signal-detail">${s.level===2?'&#x1F525;':'&#x26A0;&#xFE0F;'} ${s.text}</div>`).join('')}${signalLevel===2?`<div style="margin-top:5px;"><button class="btn btn-orange btn-sm" onclick="openLogModal('${gLabel}','Live ML','Mean Reversion')">Log Bet</button></div>`:''}</div>`:''}
          ${isLive&&!signals.length?`<div style="text-align:center;padding:4px;font-size:10px;color:var(--gray);">No signals</div>`:''}
        </div></div>`;

      // 3PT TRACKER CARD
      if (isLive) {
        const ap=parseFloat(a3P)||0, hp=parseFloat(h3P)||0;
        const aHot=ap>=50&&parseInt(a3A)>=8, hHot=hp>=50&&parseInt(h3A)>=8;
        const aWarm=ap>=45&&parseInt(a3A)>=6&&!aHot, hWarm=hp>=45&&parseInt(h3A)>=6&&!hHot;
        const cb=(aHot||hHot)?'hot-card':(aWarm||hWarm)?'warm-card':'';
        const qBoxes=(t,p,m,a)=>{const pv=parseFloat(p)||0,mv=parseInt(m)||0,av=parseInt(a)||0;let b='';for(let q=1;q<=4;q++){const act=q===per,past=q<per;if(past||act){const hc2=pv>=50&&av>=8&&act?'hot-q':act?'active-q':'';b+=`<div class="qtr-box ${hc2}"><div class="qtr-label">Q${q}${act?' *':''}</div><div class="qtr-value ${act&&pv>=50?'hot-val':'normal-val'}">${act?pv.toFixed(0)+'%':'-'}</div><div class="qtr-detail">${act?mv+'/'+av:'done'}</div></div>`;}else b+=`<div class="qtr-box"><div class="qtr-label">Q${q}</div><div class="qtr-value normal-val">-</div><div class="qtr-detail">-</div></div>`;}return b;};
        const tRow=(t,p,m,a,hot,warm)=>{const badge=hot?'<span class="signal-badge signal-fire">UNSUSTAINABLE</span>':warm?'<span class="signal-badge signal-moderate">ELEVATED</span>':'<span class="signal-badge signal-none">Normal</span>';return `<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;"><span style="font-weight:800;font-size:14px;color:var(--navy);">${t}</span>${badge}</div>${bar3(p,m,a,t)}<div class="qtr-grid">${qBoxes(t,p,m,a)}</div></div>`;};
        tpCards+=`<div class="three-pt-card ${cb}"><div class="three-pt-card-header"><span>${gLabel}</span><span>Q${per} ${clk}</span></div><div class="three-pt-card-body">${tRow(aA,a3P,a3M,a3A,aHot,aWarm)}${tRow(hA,h3P,h3M,h3A,hHot,hWarm)}${(aHot||hHot)?`<div style="text-align:center;margin-top:6px;"><button class="btn btn-purple btn-sm" onclick="openLogModal('${gLabel}','3PT Reg','3PT Regression')">Log 3PT Bet</button></div>`:''}</div></div>`;
      }
    }

    grid.innerHTML = cards || `<div class="empty-state" style="grid-column:1/-1;"><p>No games.</p></div>`;
    tpGrid.innerHTML = tpCards || `<div class="empty-state" style="grid-column:1/-1;"><p>No live games.</p></div>`;

    // Update counts
    document.getElementById('live-3pt-signals').textContent = sig3;
    document.getElementById('live-star-signals').textContent = sigStar;
    document.getElementById('live-combined-signals').textContent = sigCombined;
    document.getElementById('live-fragile-leads').textContent = sigFragile;
    document.getElementById('threept-hot-count').textContent = hotTeams;
    document.getElementById('threept-warm-count').textContent = warmTeams;

    const totalSigs = sig3+sigStar+sigFragile;
    if (totalSigs>0) { document.getElementById('live-badge').style.display='inline'; document.getElementById('live-badge').textContent=totalSigs; }
    else document.getElementById('live-badge').style.display='none';
    if (hotTeams>0) { document.getElementById('threept-badge').style.display='inline'; document.getElementById('threept-badge').textContent=hotTeams; }

    // EDGE THESIS PANEL
    const etc = document.getElementById('edgeThesisContainer');
    const etCards = document.getElementById('edgeThesisCards');
    if (gameTheses.length > 0) {
      etc.classList.add('active');
      document.getElementById('thesisCount').textContent = gameTheses.length + ' LIVE';
      // Sort by confidence (high first)
      gameTheses.sort((a,b) => (b.strongCount||0) - (a.strongCount||0));
      etCards.innerHTML = gameTheses.map(t => {
        const confDots = Array.from({length:5}, (_,i) => {
          if (i < t.strongCount) return `<div class="conf-dot lit-red"></div>`;
          if (i < t.totalMet) return `<div class="conf-dot lit"></div>`;
          return `<div class="conf-dot"></div>`;
        }).join('');
        const confCls = t.confidence==='high'?'high':t.confidence==='medium'?'medium':'low';
        const scoreDiff = Math.abs(t.aScore - t.hScore);
        const leading = t.aScore > t.hScore ? t.aTeam : t.hScore > t.aScore ? t.hTeam : 'TIE';
        const trailing = t.aScore > t.hScore ? t.hTeam : t.hScore > t.aScore ? t.aTeam : '';

        // Build criteria cards
        const criteriaKeys = ['3pt_away','3pt_home','star_away','star_home','paint_away','paint_home','foul_away','foul_home'];
        const criteriaHTML = criteriaKeys.map(k => {
          const c = t.criteria[k];
          if (!c) return '';
          const cls = c.met ? (c.strong ? 'met' : 'met') : 'not-met';
          const icon = c.met ? (c.strong ? '&#x1F525;' : '&#x26A0;&#xFE0F;') : '&#x2796;';
          const valCls = c.met ? (c.strong ? '' : 'warn') : 'neg';
          return `<div class="criteria-item ${cls}">
            <span class="criteria-check">${icon}</span>
            <div class="criteria-text">
              <span class="criteria-label">${c.label}</span>
              <span class="criteria-value ${valCls}">${c.value}</span>
              <span class="criteria-detail">${c.detail}</span>
            </div>
          </div>`;
        }).filter(Boolean).join('');

        return `<div class="thesis-card">
          <div class="thesis-game-bar">
            <div>
              <div class="thesis-game-label">${t.game}</div>
              <div class="thesis-game-period">Q${t.per} ${t.clk} ${leading!=='TIE'?`| ${leading} leads by ${scoreDiff}`:'| Tied'}</div>
            </div>
            <div class="thesis-confidence">
              <div class="conf-meter">${confDots}</div>
              <span class="conf-label ${confCls}">${t.totalMet} criteria met</span>
            </div>
          </div>
          <div class="thesis-body">
            <div class="thesis-bet-line">
              <div>
                <div class="thesis-bet-action">BET ${t.betSide} ML</div>
                <div class="thesis-bet-side">Fade ${t.fadeSide} &mdash; ${t.confidence.toUpperCase()} confidence</div>
              </div>
              <button class="btn btn-orange btn-sm" onclick="openLogModal('${t.game}','Live ML','Mean Reversion')">Log This Bet</button>
            </div>
            <div class="thesis-logic">
              <div class="thesis-logic-title">Why This Is an Edge</div>
              <div class="thesis-logic-text">${t.betLogic} The live moneyline is priced on the current score, but the current score is built on unsustainable conditions. When those conditions normalize (3PT% drops, star heats up, paint scoring returns to mean), the true probability shifts toward ${t.betSide}. The market is slow to reprice these temporary swings &mdash; that's the edge.</div>
            </div>
            <div class="thesis-criteria">${criteriaHTML}</div>
            <div class="thesis-actions">
              <span style="font-size:10px;color:#666;">${t.aTeam} ${t.aScore} - ${t.hScore} ${t.hTeam} | ${t.detail}</span>
              <button class="btn btn-green btn-sm" onclick="openLogModal('${t.game}','Live ML','Mean Reversion')">Log Bet</button>
            </div>
          </div>
        </div>`;
      }).join('');
    } else { etc.classList.remove('active'); etCards.innerHTML = ''; }

    updateStarTracker(events);

  } catch (err) {
    setConnStatus('error');
    if (state.consecutiveErrors < 3) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p style="color:var(--orange);">Connection issue (${err.message}). Retrying next cycle...</p></div>`;
    } else {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p style="color:var(--red);">Connection failed ${state.consecutiveErrors}x. ESPN may be rate-limiting. Wait 30s then try again.</p></div>`;
    }
  }
}

// ==================== STAR TRACKER ====================
function updateStarTracker(events) {
  const tb = document.getElementById('live-star-status');
  let rows = '';
  for (const ev of events) {
    if (ev.status?.type?.state !== 'in') continue;
    const comp = ev.competitions?.[0]; if (!comp) continue;
    const per=ev.status?.period||1, clk=ev.status?.displayClock||'12:00';
    const cM=parseFloat(clk?.split(':')[0]||12), cS=parseFloat(clk?.split(':')[1]||0);
    const gMins=(per-1)*12+(12-cM-cS/60), gPct=Math.min(gMins/48,1);
    for (const team of (comp.competitors||[])) {
      const tA=team.team?.abbreviation||'';
      const aT=comp.competitors?.find(c=>c.homeAway==='away'), hT=comp.competitors?.find(c=>c.homeAway==='home');
      const gl=`${aT?.team?.abbreviation||''} @ ${hT?.team?.abbreviation||''}`;
      for (const cat of (team.leaders||[])) {
        if (cat.name!=='points') continue;
        for (const l of (cat.leaders||[])) {
          const nm=l.athlete?.shortName||l.athlete?.displayName||'';
          const pts=parseFloat(l.value)||0;
          const star=state.stars.find(s=>nm.toLowerCase().includes(s.name.split(' ').pop().toLowerCase())&&s.team===tA);
          if (!star) continue;
          const exp=getExpectedByTime(star.ppg,gMins), pr=exp>0?(pts/exp*100):100;
          const q1E=getQ1Expected(star.ppg), hE=getHalfExpected(star.ppg);
          let q1T='-';
          if (per>=2) q1T=`${q1E.toFixed(1)} exp`;
          else if (per===1) { const p=q1E>0?(pts/q1E*100):100; q1T=`<span style="color:${p<60?'var(--red)':p<80?'var(--orange)':'var(--green)'};font-weight:700;">${p.toFixed(0)}%</span> of ${q1E.toFixed(1)}`; }
          let hT2='-';
          if (per>=3) hT2=`${hE.toFixed(1)} exp`;
          else if (per===2||(per===1&&gMins>0)) { const p=hE>0?(pts/hE*100):100; hT2=`<span style="color:${p<60?'var(--red)':p<80?'var(--orange)':'var(--green)'};font-weight:700;">${p.toFixed(0)}%</span> of ${hE.toFixed(1)}`; }
          const fc=pr<60?'var(--red)':pr<80?'var(--orange)':'var(--green)';
          const sig=pr<60&&gPct>=0.2&&per<=3?'<span class="signal-badge signal-fire">COLD - BET</span>':pr<75?'<span class="signal-badge signal-moderate">Below Pace</span>':'<span class="signal-badge signal-none">On Pace</span>';
          rows+=`<tr class="star-row"><td><strong>${nm}</strong><br><span style="font-size:9px;color:var(--gray);">${star.ppg} PPG</span></td><td>${gl}</td><td style="font-size:16px;font-weight:800;">${pts}</td><td>${q1T}</td><td>${hT2}</td><td><div class="pace-indicator"><div class="pace-fill" style="width:${Math.min(pr,100)}%;background:${fc};"></div></div> ${pr.toFixed(0)}%</td><td>Q${per} ${clk}</td><td>${sig}</td></tr>`;
        }
      }
    }
  }
  tb.innerHTML = rows || '<tr><td colspan="8" class="empty-state">No tracked stars in live games.</td></tr>';
}

// ==================== STAR DB ====================
function renderStarDB() {
  const tb = document.getElementById('star-db-body');
  tb.innerHTML = state.stars.map((s,i) => {
    const q1=getQ1Expected(s.ppg), h=getHalfExpected(s.ppg);
    return `<tr><td><strong>${s.name}</strong></td><td>${s.team}</td><td>${s.ppg}</td><td>${q1.toFixed(1)}</td><td>${h.toFixed(1)}</td><td>&lt;${(q1*0.6).toFixed(0)} Q1, &lt;${(h*0.6).toFixed(0)} half</td><td><button class="btn btn-red btn-sm" onclick="removeStar(${i})">X</button></td></tr>`;
  }).join('');
}
function addStar() {
  const n=document.getElementById('add-star-name').value.trim(), t=document.getElementById('add-star-team').value.trim().toUpperCase(), p=parseFloat(document.getElementById('add-star-ppg').value);
  if (!n||!t||isNaN(p)) { alert('Fill all fields'); return; }
  state.stars.push({name:n,team:t,ppg:p}); localStorage.setItem('starPlayers',JSON.stringify(state.stars)); renderStarDB();
  document.getElementById('add-star-name').value=''; document.getElementById('add-star-team').value=''; document.getElementById('add-star-ppg').value='';
}
function removeStar(i) { state.stars.splice(i,1); localStorage.setItem('starPlayers',JSON.stringify(state.stars)); renderStarDB(); }

// ==================== BET LOG ====================
function openLogModal(g,p,s) { document.getElementById('modal-game').value=g; document.getElementById('modal-price').value=p; document.getElementById('modal-strategy').value=s; document.getElementById('modal-side').value=''; document.getElementById('modal-notes').value=''; document.getElementById('logModal').classList.add('active'); }
function closeModal() { document.getElementById('logModal').classList.remove('active'); }
function confirmLogBet() {
  state.betLog.push({date:new Date().toLocaleDateString(),strategy:document.getElementById('modal-strategy').value,game:document.getElementById('modal-game').value,side:document.getElementById('modal-side').value,price:document.getElementById('modal-price').value,units:parseFloat(document.getElementById('modal-units').value),result:'Pending',profit:0,notes:document.getElementById('modal-notes').value,id:Date.now()});
  localStorage.setItem('betLog',JSON.stringify(state.betLog)); renderBetLog(); closeModal();
}
function renderBetLog() {
  const tb=document.getElementById('bet-log-body');
  if (!state.betLog.length) { tb.innerHTML='<tr><td colspan="9" class="empty-state">No bets logged.</td></tr>'; updateLogStats(); return; }
  tb.innerHTML = state.betLog.slice().reverse().map(b => {
    const rc=b.result==='W'?'move-up':b.result==='L'?'move-down':'';
    const sb=b.strategy==='3PT Regression'?'signal-purple':b.strategy==='Paint Durability'?'signal-teal':b.strategy==='Foul Trouble'?'signal-moderate':'signal-strong';
    return `<tr><td>${b.date}</td><td><span class="signal-badge ${sb}">${b.strategy}</span></td><td>${b.game}</td><td>${b.side}</td><td>${b.price}</td><td>${b.units}</td><td class="${rc}">${b.result}</td><td class="${b.profit>=0?'move-up':'move-down'}">${b.profit>0?'+':''}${b.profit.toFixed(2)}u</td><td>${b.result==='Pending'?`<button class="btn btn-green btn-sm" onclick="resolveBet(${b.id},'W')">W</button> <button class="btn btn-red btn-sm" onclick="resolveBet(${b.id},'L')">L</button> <button class="btn btn-outline btn-sm" onclick="resolveBet(${b.id},'Push')">P</button>`:''}</td></tr>`;
  }).join('');
  updateLogStats();
}
function resolveBet(id,r) {
  const b=state.betLog.find(x=>x.id===id); if(!b) return; b.result=r;
  if(r==='W'){const p=parseInt(b.price)||-110; b.profit=p>0?b.units*(p/100):b.units*(100/Math.abs(p));}
  else if(r==='L') b.profit=-b.units; else b.profit=0;
  localStorage.setItem('betLog',JSON.stringify(state.betLog)); renderBetLog();
}
function updateLogStats() {
  const r=state.betLog.filter(b=>b.result!=='Pending'), w=r.filter(b=>b.result==='W').length, t=r.length;
  const nu=r.reduce((s,b)=>s+b.profit,0), tr=r.reduce((s,b)=>s+b.units,0);
  document.getElementById('log-total').textContent=state.betLog.length;
  document.getElementById('log-winrate').textContent=t>0?(w/t*100).toFixed(1)+'%':'-';
  document.getElementById('log-net-units').textContent=(nu>=0?'+':'')+nu.toFixed(2);
  document.getElementById('log-net-units').className=`stat-value ${nu>=0?'green':'red'}`;
  document.getElementById('log-roi').textContent=tr>0?(nu/tr*100).toFixed(1)+'%':'-';
  let streak=0,st='';
  for(let i=r.length-1;i>=0;i--){if(i===r.length-1){st=r[i].result;streak=1;}else if(r[i].result===st)streak++;else break;}
  const se=document.getElementById('log-streak');
  if(streak>0){se.textContent=streak+st;se.className=`stat-value ${st==='W'?'green':st==='L'?'red':''}`;}else se.textContent='-';
}
function clearLog(){if(confirm('Clear ALL?')){state.betLog=[];localStorage.setItem('betLog','[]');renderBetLog();}}
function exportLog(){
  if(!state.betLog.length){alert('No bets');return;}
  const h='Date,Strategy,Game,Side,Price,Units,Result,Profit,Notes\n';
  const r=state.betLog.map(b=>`${b.date},${b.strategy},"${b.game}",${b.side},${b.price},${b.units},${b.result},${b.profit.toFixed(2)},"${b.notes}"`).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([h+r],{type:'text/csv'}));a.download=`NBA_Edge_${new Date().toISOString().slice(0,10)}.csv`;a.click();
}

// ==================== BANKROLL ====================
function updateBankroll() {
  const s=parseFloat(document.getElementById('bankroll-start').value)||0, c=parseFloat(document.getElementById('bankroll-current').value)||0;
  state.bankroll={start:s,current:c}; localStorage.setItem('bankroll',JSON.stringify(state.bankroll));
  const u=c*0.01;
  document.getElementById('br-unit').textContent=u>0?'$'+u.toFixed(0):'-';
  document.getElementById('br-max').textContent=u>0?'$'+(u*2).toFixed(0):'-';
  document.getElementById('br-daily').textContent=u>0?'$'+(u*5).toFixed(0):'-';
  const pl=c-s;
  document.getElementById('br-pl').textContent=s>0?(pl>=0?'+':'')+`$${pl.toFixed(0)}`:'-';
  document.getElementById('br-pl').className=`stat-value ${pl>=0?'green':'red'}`;
  const pct=s>0?(pl/s*100):0;
  document.getElementById('br-pl-pct').textContent=s>0?(pct>=0?'+':'')+pct.toFixed(1)+'%':'-';
  document.getElementById('br-pl-pct').className=`stat-value ${pct>=0?'green':'red'}`;
}
document.getElementById('logModal').addEventListener('click',function(e){if(e.target===this)closeModal();});


// ==================== SOUND SYSTEM (Web Audio API) ====================
let audioCtx = null;
let soundEnabled = JSON.parse(localStorage.getItem('soundEnabled') || 'true');

function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playAlertSound(type) {
  if (!soundEnabled) return;
  const ctx = initAudio();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  
  if (type === 'cold') {
    // Descending alert: urgent but not annoying
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15);
    osc.frequency.setValueAtTime(880, ctx.currentTime + 0.2);
    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.35);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.5);
  } else if (type === 'hot3pt') {
    // Triple beep for 3PT
    osc.type = 'square';
    gain.gain.setValueAtTime(0, ctx.currentTime);
    for (let i = 0; i < 3; i++) {
      const t = ctx.currentTime + i * 0.15;
      osc.frequency.setValueAtTime(660, t);
      gain.gain.setValueAtTime(0.2, t);
      gain.gain.setValueAtTime(0, t + 0.08);
    }
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.5);
  } else if (type === 'combined') {
    // Epic alert for combined signals
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(440, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.2);
    osc.frequency.setValueAtTime(440, ctx.currentTime + 0.25);
    osc.frequency.exponentialRampToValueAtTime(1100, ctx.currentTime + 0.45);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.6);
  }
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  localStorage.setItem('soundEnabled', JSON.stringify(soundEnabled));
  const btn = document.getElementById('soundToggle');
  btn.classList.toggle('active', soundEnabled);
  btn.innerHTML = soundEnabled ? '&#x1F50A; Sound' : '&#x1F507; Muted';
  if (soundEnabled) playAlertSound('cold'); // test beep
}

// Init sound button state
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('soundToggle');
  if (btn) {
    btn.classList.toggle('active', soundEnabled);
    btn.innerHTML = soundEnabled ? '&#x1F50A; Sound' : '&#x1F507; Muted';
  }
});

// ==================== SCENARIO ALERT SYSTEM ====================
let activeAlerts = [];
let alertIdCounter = 0;
const ALERT_HISTORY = JSON.parse(localStorage.getItem('alertHistory') || '[]');

function showScenarioAlert(data) {
  // data: { player, team, game, quarter, clock, currentPts, expectedPts, ppg, pacePercent, type, signals }
  const panel = document.getElementById('scenario-alert-panel');
  if (!panel) return;
  
  const id = 'alert-' + (++alertIdCounter);
  const paceColor = data.pacePercent < 50 ? '#4fc3f7' : data.pacePercent < 75 ? 'var(--orange)' : 'var(--green)';
  const paceFill = Math.min(data.pacePercent, 100);
  const deficit = data.expectedPts - data.currentPts;
  const deficitText = deficit > 0 ? deficit.toFixed(1) + ' pts behind' : Math.abs(deficit).toFixed(1) + ' pts ahead';
  
  let badge = 'COLD ALERT';
  let badgeBg = 'var(--red)';
  let soundType = 'cold';
  if (data.type === 'hot3pt') { badge = '3PT FIRE'; badgeBg = 'var(--orange)'; soundType = 'hot3pt'; }
  else if (data.type === 'combined') { badge = 'MULTI-SIGNAL'; badgeBg = 'linear-gradient(90deg, var(--red), var(--orange))'; soundType = 'combined'; }
  else if (data.type === 'fragile') { badge = 'FRAGILE LEAD'; badgeBg = '#e91e63'; soundType = 'cold'; }
  
  const q1Exp = (data.ppg * 0.25).toFixed(1);
  const halfExp = (data.ppg * 0.5).toFixed(1);
  const periodLabel = data.quarter <= 2 ? 'Q' + data.quarter : data.quarter <= 4 ? 'Q' + data.quarter : 'OT';
  const periodExp = data.quarter === 1 ? q1Exp : data.quarter === 2 ? halfExp : data.expectedPts.toFixed(1);
  const periodExpLabel = data.quarter === 1 ? 'Q1 Exp' : data.quarter === 2 ? 'Half Exp' : 'Exp Now';
  
  const alertEl = document.createElement('div');
  alertEl.className = 'scenario-alert';
  alertEl.id = id;
  alertEl.innerHTML = `
    <button class="alert-dismiss" onclick="dismissAlert('${id}')">&times;</button>
    <div class="alert-header">
      <span class="alert-badge" style="background:${badgeBg};">${badge}</span>
      <span class="alert-game-time">${data.game} &bull; ${periodLabel} ${data.clock}</span>
    </div>
    <div class="alert-player">${data.player}</div>
    <div class="alert-team">${data.team} &bull; ${data.ppg} PPG season avg</div>
    <div class="alert-stats">
      <div class="alert-stat">
        <div class="alert-stat-label">Current</div>
        <div class="alert-stat-value cold">${data.currentPts}</div>
      </div>
      <div class="alert-stat">
        <div class="alert-stat-label">${periodExpLabel}</div>
        <div class="alert-stat-value neutral">${periodExp}</div>
      </div>
      <div class="alert-stat">
        <div class="alert-stat-label">Pace</div>
        <div class="alert-stat-value ${data.pacePercent < 60 ? 'cold' : data.pacePercent < 80 ? 'neutral' : 'hot'}">${data.pacePercent.toFixed(0)}%</div>
      </div>
    </div>
    <div class="alert-pace-bar">
      <div class="alert-pace-fill" style="width:${paceFill}%;background:${paceColor};"></div>
      <div class="alert-pace-marker" style="left:60%;" title="60% threshold"></div>
    </div>
    <div class="alert-verdict">
      <strong>${deficitText}</strong> expected pace at ${periodLabel} ${data.clock}. 
      Stars below 60% pace at this point bounce back ~78% of the time. 
      <strong>Mean reversion candidate &mdash; live ML is mispriced.</strong>
    </div>
    <div class="alert-action">
      <button class="btn btn-orange btn-sm" onclick="openLogModal('${data.game}','Live ML','Mean Reversion')">Log Bet</button>
      <button class="btn btn-outline btn-sm" onclick="dismissAlert('${id}')">Dismiss</button>
    </div>
  `;
  
  panel.appendChild(alertEl);
  activeAlerts.push(id);
  
  // Play sound
  playAlertSound(soundType);
  
  // Auto-dismiss after 30s
  setTimeout(() => dismissAlert(id), 30000);
  
  // Save to history
  ALERT_HISTORY.unshift({ ...data, time: new Date().toISOString() });
  if (ALERT_HISTORY.length > 50) ALERT_HISTORY.length = 50;
  localStorage.setItem('alertHistory', JSON.stringify(ALERT_HISTORY));
}

function dismissAlert(id) {
  const el = document.getElementById(id);
  if (el) {
    el.style.animation = 'alertSlideIn 0.3s ease-in reverse';
    setTimeout(() => el.remove(), 300);
  }
  activeAlerts = activeAlerts.filter(a => a !== id);
}

// ==================== DEMO SIMULATION MODE ====================
function runDemoScenario() {
  // Initialize audio on user gesture
  initAudio();
  
  const scenarios = [
    {
      player: 'Jalen Brunson', team: 'NYK &bull; New York Knicks', game: 'NYK @ BOS',
      quarter: 2, clock: '1:01', currentPts: 3, ppg: 26.3,
      expectedPts: 14.5, pacePercent: 20.7, type: 'cold',
      signals: ['Star at 21% pace', 'Mean reversion candidate']
    },
    {
      player: 'Shai Gilgeous-Alexander', team: 'OKC &bull; Oklahoma City Thunder', game: 'OKC @ LAL',
      quarter: 1, clock: '2:30', currentPts: 2, ppg: 32.2,
      expectedPts: 7.7, pacePercent: 26.0, type: 'cold',
      signals: ['Star at 26% Q1 pace', 'Below 60% threshold']
    },
    {
      player: 'Luka Doncic', team: 'DAL &bull; Dallas Mavericks', game: 'DAL @ MIA',
      quarter: 2, clock: '5:45', currentPts: 4, ppg: 28.1,
      expectedPts: 11.7, pacePercent: 34.2, type: 'combined',
      signals: ['Star cold + MIA shooting 55% from 3', 'Multi-signal edge']
    },
    {
      player: 'Jaren Jackson Jr', team: 'MEM \x26bull; Memphis Grizzlies', game: 'MEM @ DEN',
      quarter: 3, clock: '4:22', currentPts: 78,
      expectedPts: 85.0, pacePercent: 91.8, type: 'combined',
      signals: ['MEM out-hustling on boards (12 OREB vs 6)', 'DEN shooting 54% from 3 on 13 att', 'Hustle + 3PT regression edge']
    }
  ];
  
  // Pick a random scenario or cycle through them
  const idx = Math.floor(Math.random() * scenarios.length);
  const s = scenarios[idx];
  
  showScenarioAlert(s);
}



// ==================== HOOK: FIRE SCENARIO ALERTS FROM LIVE DATA ====================
// Override the original signal detection to also trigger scenario alerts
const _origShowQuarterToast = showQuarterToast;
const _firedAlerts = new Set(); // prevent duplicate alerts per game refresh

function fireStarColdAlert(leader, star, gMins, per, clk, gLabel, paceRatio) {
  const alertKey = star.name + '_' + per + '_' + Math.floor(gMins);
  if (_firedAlerts.has(alertKey)) return;
  _firedAlerts.add(alertKey);
  // Clear old keys every 5 minutes
  setTimeout(() => _firedAlerts.delete(alertKey), 300000);
  
  const exp = getExpectedByTime(star.ppg, gMins);
  showScenarioAlert({
    player: leader.name,
    team: star.team,
    game: gLabel,
    quarter: per,
    clock: clk,
    currentPts: leader.pts,
    expectedPts: exp,
    ppg: star.ppg,
    pacePercent: paceRatio * 100,
    type: 'cold',
    signals: ['Star at ' + (paceRatio * 100).toFixed(0) + '% pace', 'Below 60% threshold']
  });
}

function fire3PTAlert(teamAbbr, pct, made, att, gLabel, per, clk) {
  const alertKey = teamAbbr + '_3pt_' + per;
  if (_firedAlerts.has(alertKey)) return;
  _firedAlerts.add(alertKey);
  setTimeout(() => _firedAlerts.delete(alertKey), 300000);
  
  showScenarioAlert({
    player: teamAbbr + ' Team',
    team: teamAbbr + ' shooting unsustainably hot',
    game: gLabel,
    quarter: per,
    clock: clk,
    currentPts: parseFloat(pct),
    expectedPts: getLeague3PtAvg(),
    ppg: getLeague3PtAvg(),
    pacePercent: (parseFloat(pct) / getLeague3PtAvg()) * 100,
    type: 'hot3pt',
    signals: [teamAbbr + ' at ' + pct + '% from 3 (' + made + '/' + att + ')']
  });
}

</script>
<div id="content-guide" class="tab-content">
<div class="guide-section">
<h2 style="font-size:22px;font-weight:700;margin-bottom:4px">Signal Guide</h2>
<div id="nba-guide">
<p class="guide-intro">Each signal identifies a specific market inefficiency in live NBA games. When conditions are met, the live moneyline is likely mispriced.</p>
<div class="guide-grid">
<div class="guide-card"><h3><span class="signal-badge badge-3pt">3PT</span> 3PT Regression</h3><p class="edge-label">The Edge: Unsustainable Shooting Regresses to Mean</p><p>When a team shoots 50%+ from three on 8+ attempts, this rate is almost certainly unsustainable.</p><div class="threshold">Thresholds: &ge;50% on &ge;8 attempts, or &ge;45% on &ge;6</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-star">STAR</span> Star Cold</h3><p class="edge-label">The Edge: Star Performance Regresses Upward</p><p>When a franchise player shoots well below their season average, regression suggests their production will improve.</p><div class="threshold">Thresholds: Star shooting 15%+ below season avg, 8+ min played</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-fragile">FRAGILE</span> Fragile Lead</h3><p class="edge-label">The Edge: 3PT-Built Leads Are Structurally Weak</p><p>When 42%+ of points come from 3PT and team is leading, that lead is built on the most volatile shot.</p><div class="threshold">Thresholds: 3PT pts &ge;42% of total, &ge;20 3PT attempts, leading</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-paint">PAINT</span> Paint Durability</h3><p class="edge-label">The Edge: Inside Scoring = Sustainable Advantage</p><p>Teams scoring heavily in the paint have a structural advantage &mdash; close-range shots don't regress like 3PT.</p><div class="threshold">Thresholds: Paint points percentage and volume above league average</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-foul">FOUL</span> Foul Trouble</h3><p class="edge-label">The Edge: Foul Rate Predicts Free Throw Swings</p><p>When a team is fouling at an elevated rate, they're on pace to put the opponent in the bonus early.</p><div class="threshold">Thresholds: &ge;6.5 fouls per 12 min, or &ge;10 total</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-hustle">HUSTLE</span> Hustle Edge</h3><p class="edge-label">The Edge: Offensive Rebound Dominance Shows Hidden Effort</p><p>When a trailing team dominates offensive rebounds, they're generating extra possessions through pure effort. Each OREB is worth ~1.1 points of hidden value.</p><div class="threshold">Thresholds: &ge;4 OREB advantage while trailing, minimum 6 total OREB in game</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-combined">COMBINED</span> Combined Edge</h3><p class="edge-label">The Edge: Stacked Signals Compound</p><p>When multiple signals point the same direction, the edge multiplies.</p><div class="threshold">Scoring: +1 per signal per side, 2+ = actionable edge</div></div>
</div></div>
<div id="ncaa-guide" style="display:none">
<p class="guide-intro">NCAA signals calibrated for college basketball: 5-foul limit, earlier bonus, two 20-min halves. Star Cold replaced by Team Offensive Slump.</p>
<div class="guide-grid">
<div class="guide-card"><h3><span class="signal-badge badge-3pt">3PT</span> 3PT Regression</h3><p class="edge-label">The Edge: College Shooters Regress Harder</p><p>College teams have even more 3PT variance. Hot shooting is less sustainable with younger shooters.</p><div class="threshold">Thresholds: &ge;50% on &ge;8 attempts, or &ge;45% on &ge;6</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-star">TEAM</span> Team Offensive Slump</h3><p class="edge-label">The Edge: Team Efficiency Regresses to Mean</p><p>Instead of tracking one star, we track team offensive efficiency vs season average. Markets overreact to cold stretches.</p><div class="threshold">Thresholds: Offensive rating 15%+ below season avg, 8+ min played</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-fragile">FRAGILE</span> Fragile Lead</h3><p class="edge-label">The Edge: 3PT-Built Leads Collapse Faster</p><p>College teams are more 3PT-dependent. Leads built on hot shooting are structurally weaker.</p><div class="threshold">Thresholds: 3PT pts &ge;42% of total, &ge;20 3PT attempts, leading</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-paint">PAINT</span> Paint Durability</h3><p class="edge-label">The Edge: Inside Scoring = Sustainable</p><p>Paint scoring in college reflects size mismatches and scheme advantages that persist.</p><div class="threshold">Thresholds: Paint points percentage and volume above average</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-foul">FOUL</span> Foul Trouble</h3><p class="edge-label">The Edge: 5 Fouls + Early Bonus</p><p>STRONGER in NCAA. 5-foul limit, bonus at 7th team foul per half, double bonus at 10th.</p><div class="threshold">Thresholds: &ge;5.0 per 10 min, or &ge;7 total in a half</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-hustle">HUSTLE</span> Hustle Edge</h3><p class="edge-label">The Edge: Offensive Rebound Dominance Shows Hidden Effort</p><p>When a trailing team dominates offensive rebounds, they're generating extra possessions through pure effort. Each OREB is worth ~1.1 points of hidden value.</p><div class="threshold">Thresholds: &ge;4 OREB advantage while trailing, minimum 6 total OREB in game</div></div>
<div class="guide-card"><h3><span class="signal-badge badge-combined">COMBINED</span> Combined Edge</h3><p class="edge-label">The Edge: Stacked Signals Compound</p><p>Multiple signals pointing same direction = stronger edge. More powerful in NCAA where markets are less efficient.</p><div class="threshold">Scoring: +1 per signal per side</div></div>
</div></div>
</div></div>
</body>
</html>

