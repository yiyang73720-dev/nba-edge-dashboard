<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Edge System Dashboard</title>
<style>
  :root {
    --navy: #1B3A5C;
    --blue: #2E75B6;
    --light-blue: #E8F0FE;
    --green: #28A745;
    --red: #DC3545;
    --orange: #FD7E14;
    --yellow: #FFC107;
    --gray: #6C757D;
    --light-gray: #F8F9FA;
    --border: #DEE2E6;
    --white: #FFFFFF;
    --dark: #212529;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --purple: #6F42C1;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F0F2F5; color: var(--dark); line-height: 1.5; }

  .header { background: linear-gradient(135deg, var(--navy) 0%, var(--blue) 100%); color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
  .header h1 { font-size: 20px; font-weight: 700; letter-spacing: 0.5px; }
  .header-right { display: flex; align-items: center; gap: 12px; }

  .btn { padding: 6px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: var(--white); color: var(--navy); }
  .btn-primary:hover { background: var(--light-blue); }
  .btn-green { background: var(--green); color: white; }
  .btn-green:hover { background: #218838; }
  .btn-red { background: var(--red); color: white; }
  .btn-red:hover { background: #c82333; }
  .btn-orange { background: var(--orange); color: white; }
  .btn-orange:hover { background: #e8690b; }
  .btn-purple { background: var(--purple); color: white; }
  .btn-purple:hover { background: #5a32a3; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--gray); }
  .btn-outline:hover { background: var(--light-gray); }

  .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
  .status-dot.live { background: var(--green); animation: pulse 1.5s infinite; }
  .status-dot.off { background: var(--gray); }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .tab-bar { display: flex; background: var(--white); border-bottom: 2px solid var(--border); padding: 0 24px; box-shadow: var(--shadow); flex-wrap: wrap; }
  .tab { padding: 12px 20px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--gray); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
  .tab:hover { color: var(--navy); }
  .tab.active { color: var(--navy); border-bottom-color: var(--blue); }
  .tab .badge { background: var(--red); color: white; border-radius: 10px; padding: 1px 7px; font-size: 11px; margin-left: 6px; }
  .tab .badge-purple { background: var(--purple); }

  .container { max-width: 1400px; margin: 0 auto; padding: 20px 24px; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .card { background: var(--white); border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 16px; overflow: hidden; }
  .card-header { padding: 14px 20px; font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
  .card-body { padding: 16px 20px; }

  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px; }
  .stat-card { background: var(--white); border-radius: 10px; padding: 16px 20px; box-shadow: var(--shadow); text-align: center; }
  .stat-label { font-size: 11px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .stat-value { font-size: 28px; font-weight: 800; color: var(--navy); }
  .stat-value.green { color: var(--green); }
  .stat-value.red { color: var(--red); }
  .stat-value.orange { color: var(--orange); }
  .stat-value.purple { color: var(--purple); }
  .stat-sub { font-size: 12px; color: var(--gray); margin-top: 2px; }

  table { width: 100%; border-collapse: collapse; }
  th { background: var(--navy); color: white; padding: 10px 12px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
  tr:nth-child(even) { background: var(--light-gray); }
  tr:hover { background: var(--light-blue); }

  .move-up { color: var(--green); font-weight: 700; }
  .move-down { color: var(--red); font-weight: 700; }

  .signal-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
  .signal-strong { background: #d4edda; color: #155724; }
  .signal-moderate { background: #fff3cd; color: #856404; }
  .signal-none { background: #f8f9fa; color: #6c757d; }
  .signal-fire { background: #f8d7da; color: #842029; }
  .signal-purple { background: #e8daef; color: #4a235a; }

  .alert-bar { background: linear-gradient(90deg, #fff3cd 0%, #ffe69c 100%); border-left: 4px solid var(--orange); padding: 12px 20px; margin-bottom: 16px; border-radius: 0 8px 8px 0; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; color: #664d03; }
  .alert-bar.alert-red { background: linear-gradient(90deg, #f8d7da, #f5c2c7); border-left-color: var(--red); color: #842029; }
  .alert-bar.alert-green { background: linear-gradient(90deg, #d1e7dd 0%, #badbcc 100%); border-left-color: var(--green); color: #0f5132; }
  .alert-bar.alert-purple { background: linear-gradient(90deg, #e8daef 0%, #d7bde2 100%); border-left-color: var(--purple); color: #4a235a; }
  .alert-bar .close-alert { cursor: pointer; margin-left: auto; font-size: 18px; opacity: 0.6; }
  .alert-bar .close-alert:hover { opacity: 1; }

  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
  .form-group { display: flex; flex-direction: column; }
  .form-group label { font-size: 11px; font-weight: 600; color: var(--gray); margin-bottom: 4px; text-transform: uppercase; }
  .form-group input, .form-group select { padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; }
  .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(46,117,182,0.15); }

  .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 16px; }
  .game-card { background: var(--white); border-radius: 10px; box-shadow: var(--shadow); overflow: hidden; border: 2px solid transparent; transition: border-color 0.3s; }
  .game-card.signal-fire { border-color: var(--red); box-shadow: 0 0 16px rgba(220,53,69,0.25); }
  .game-card.signal-warn { border-color: var(--orange); box-shadow: 0 0 12px rgba(253,126,20,0.2); }
  .game-card-header { padding: 10px 16px; background: var(--navy); color: white; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
  .game-card-header.live-pulse { background: linear-gradient(135deg, #1a5c3a 0%, #28a745 100%); }
  .game-card-body { padding: 14px 16px; }
  .game-teams { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .team-block { text-align: center; flex: 1; }
  .team-name { font-size: 15px; font-weight: 800; color: var(--navy); }
  .team-record { font-size: 10px; color: var(--gray); }
  .team-score { font-size: 34px; font-weight: 900; color: var(--dark); margin: 2px 0; }
  .vs-block { text-align: center; padding: 0 8px; }
  .vs-text { font-size: 11px; color: var(--gray); font-weight: 700; }
  .game-period { font-size: 11px; color: var(--orange); font-weight: 800; }

  /* STAT BARS */
  .stat-bars { padding-top: 10px; border-top: 1px solid var(--border); }
  .stat-bar-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 12px; }
  .stat-bar-label { width: 90px; font-weight: 600; color: var(--gray); flex-shrink: 0; }
  .stat-bar-track { flex: 1; height: 20px; background: #eee; border-radius: 10px; overflow: hidden; position: relative; }
  .stat-bar-fill { height: 100%; border-radius: 10px; transition: width 0.5s; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: white; min-width: 30px; }
  .stat-bar-fill.hot { background: linear-gradient(90deg, var(--orange), var(--red)); }
  .stat-bar-fill.normal { background: var(--blue); }
  .stat-bar-fill.cold { background: var(--gray); }
  .stat-bar-avg { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--dark); z-index: 1; }
  .stat-bar-avg::after { content: attr(data-label); position: absolute; top: -14px; left: -10px; font-size: 9px; color: var(--gray); white-space: nowrap; }
  .stat-bar-value { width: 65px; text-align: right; font-weight: 700; flex-shrink: 0; margin-left: 6px; }

  /* SIGNAL PANEL */
  .signal-panel { margin-top: 10px; padding: 10px 14px; border-radius: 8px; background: #fff8e1; border: 1px solid #ffe082; }
  .signal-panel.strong { background: #fce4ec; border-color: #ef9a9a; }
  .signal-panel.fire { background: #ffebee; border-color: #ef5350; animation: glow 2s infinite; }
  @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(239,83,80,0.2); } 50% { box-shadow: 0 0 15px rgba(239,83,80,0.4); } }
  .signal-title { font-size: 12px; font-weight: 800; margin-bottom: 4px; }
  .signal-title.fire { color: var(--red); }
  .signal-title.warn { color: #e65100; }

  .signal-detail { font-size: 11px; color: #555; line-height: 1.6; }

  /* 3PT TRACKER CARDS */
  .three-pt-card { background: var(--white); border-radius: 10px; box-shadow: var(--shadow); overflow: hidden; border: 2px solid transparent; transition: all 0.3s; }
  .three-pt-card.hot-card { border-color: var(--red); box-shadow: 0 0 16px rgba(220,53,69,0.3); }
  .three-pt-card.warm-card { border-color: var(--orange); box-shadow: 0 0 12px rgba(253,126,20,0.2); }
  .three-pt-card-header { padding: 10px 16px; background: var(--purple); color: white; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
  .three-pt-card-body { padding: 14px 16px; }
  .qtr-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
  .qtr-box { text-align: center; padding: 8px; border-radius: 8px; background: var(--light-gray); }
  .qtr-box.active-q { border: 2px solid var(--blue); background: var(--light-blue); }
  .qtr-box.hot-q { background: #ffebee; border: 2px solid var(--red); }
  .qtr-label { font-size: 10px; font-weight: 700; color: var(--gray); text-transform: uppercase; }
  .qtr-value { font-size: 18px; font-weight: 900; }
  .qtr-detail { font-size: 10px; color: var(--gray); }
  .qtr-value.hot-val { color: var(--red); }
  .qtr-value.normal-val { color: var(--navy); }

  /* STAR TRACKER TABLE */
  .star-row td { vertical-align: middle; }
  .pace-indicator { display: inline-block; width: 60px; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; vertical-align: middle; }
  .pace-fill { height: 100%; border-radius: 4px; }

  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; }
  .modal-overlay.active { display: flex; }
  .modal { background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
  .modal h3 { margin-bottom: 16px; color: var(--navy); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  .auto-refresh-bar { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--light-gray); border-radius: 8px; margin-bottom: 12px; font-size: 12px; }
  .auto-refresh-bar .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
  .auto-refresh-bar .dot.off { background: var(--gray); }
  .countdown-bar { width: 100px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; }
  .countdown-fill { height: 100%; background: var(--blue); transition: width 1s linear; }

  /* QUARTER ALERT TOAST */
  .quarter-alert-toast {
    position: fixed; top: 80px; right: 24px; z-index: 150;
    background: linear-gradient(135deg, #4a235a 0%, #6f42c1 100%);
    color: white; padding: 16px 20px; border-radius: 12px;
    box-shadow: 0 8px 24px rgba(111,66,193,0.4);
    max-width: 380px; animation: slideIn 0.4s ease-out, fadeOut 0.5s 12s forwards;
    cursor: pointer;
  }
  .quarter-alert-toast .toast-title { font-weight: 800; font-size: 14px; margin-bottom: 4px; }
  .quarter-alert-toast .toast-body { font-size: 12px; opacity: 0.9; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }

  @media (max-width: 768px) {
    .header { flex-direction: column; gap: 8px; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .games-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr 1fr; }
    .qtr-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>NBA EDGE SYSTEM</h1>
    <div style="font-size:12px;opacity:0.7;margin-top:2px;">Live Mean Reversion &bull; 3PT Inefficiency + Star Scorer Pace &bull; Q1/Half Pace &bull; Auto-Updating</div>
  </div>
  <div class="header-right">
    <div>
      <span class="status-dot off" id="statusDot"></span>
      <span id="statusText" style="font-size:12px;">ESPN Feed</span>
    </div>
  </div>
</div>

<div class="tab-bar">
  <div class="tab active" onclick="switchTab('live')" id="tab-live">Live Games <span class="badge" id="live-badge" style="display:none;">0</span></div>
  <div class="tab" onclick="switchTab('threept')" id="tab-threept">3PT Tracker <span class="badge badge-purple" id="threept-badge" style="display:none;">0</span></div>
  <div class="tab" onclick="switchTab('stars')" id="tab-stars">Star Tracker</div>
  <div class="tab" onclick="switchTab('log')" id="tab-log">Bet Log</div>
  <div class="tab" onclick="switchTab('bankroll')" id="tab-bankroll">Bankroll</div>
</div>

<div class="container">
  <!-- QUARTER END ALERTS (persistent) -->
  <div id="quarter-alerts"></div>

  <!-- ==================== LIVE GAMES TAB ==================== -->
  <div class="tab-content active" id="content-live">
    <div id="live-alerts"></div>

    <div class="auto-refresh-bar">
      <span class="dot" id="autoRefreshDot"></span>
      <span>Auto-refresh: <strong id="autoRefreshLabel">OFF</strong></span>
      <button class="btn btn-sm btn-green" id="autoRefreshBtn" onclick="toggleAutoRefresh()">Start</button>
      <span style="margin-left:8px;">Interval:</span>
      <select id="refreshInterval" style="padding:2px 6px;font-size:12px;border-radius:4px;border:1px solid var(--border);" onchange="updateRefreshInterval()">
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
        <option value="120">2min</option>
      </select>
      <div class="countdown-bar"><div class="countdown-fill" id="countdownFill" style="width:100%;"></div></div>
      <span style="margin-left:auto;color:var(--gray);">Last: <span id="live-last-update">-</span></span>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Live Games</div><div class="stat-value" id="live-games-count">-</div></div>
      <div class="stat-card"><div class="stat-label">3PT Signals</div><div class="stat-value orange" id="live-3pt-signals">0</div></div>
      <div class="stat-card"><div class="stat-label">Star Cold Signals</div><div class="stat-value orange" id="live-star-signals">0</div></div>
      <div class="stat-card"><div class="stat-label">Combined Signals</div><div class="stat-value red" id="live-combined-signals">0</div></div>
    </div>

    <div class="card">
      <div class="card-header"><span>Live Game Monitor (ESPN + NBA.com)</span>
        <button class="btn btn-green btn-sm" onclick="fetchESPNScoreboard()">Refresh Now</button>
      </div>
      <div class="card-body">
        <div class="games-grid" id="live-games-grid">
          <div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3C0;</div><p>Click "Refresh Now" or start auto-refresh to load live games.<br>Uses ESPN scoreboard (no API key needed).</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 3PT TRACKER TAB ==================== -->
  <div class="tab-content" id="content-threept">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Teams 50%+ 3PT</div><div class="stat-value red" id="threept-hot-count">0</div></div>
      <div class="stat-card"><div class="stat-label">Teams 45-50% 3PT</div><div class="stat-value orange" id="threept-warm-count">0</div></div>
      <div class="stat-card"><div class="stat-label">Quarter Alerts</div><div class="stat-value purple" id="threept-qtr-alerts">0</div></div>
      <div class="stat-card"><div class="stat-label">League Avg</div><div class="stat-value" style="color:var(--blue);">36.5%</div><div class="stat-sub">Season 3PT%</div></div>
    </div>

    <div class="card">
      <div class="card-header">
        <span>3-Point Shooting Tracker - Live by Quarter</span>
        <span style="font-size:11px;color:var(--gray);">Alert at 50%+ on 8+ attempts per quarter</span>
      </div>
      <div class="card-body">
        <div class="games-grid" id="threept-grid">
          <div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3AF;</div><p>3PT tracking will populate when live games are running.<br>Tracks per-quarter shooting rates and alerts on unsustainable streaks.</p></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><span>Quarter-End Alerts History</span><button class="btn btn-sm btn-outline" onclick="clearQtrAlerts()">Clear</button></div>
      <div class="card-body">
        <table>
          <thead><tr><th>Time</th><th>Team</th><th>Quarter</th><th>3PT%</th><th>Made/Att</th><th>Game</th><th>Action</th></tr></thead>
          <tbody id="qtr-alerts-body"><tr><td colspan="7" class="empty-state">No quarter-end alerts yet. Triggers when a team ends a quarter shooting 50%+ from 3.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== STAR TRACKER TAB ==================== -->
  <div class="tab-content" id="content-stars">
    <div class="card">
      <div class="card-header"><span>Star Player Database (23+ PPG)</span>
        <span style="font-size:11px;color:var(--gray);">Season averages used for pace calculation</span>
      </div>
      <div class="card-body" style="font-size:13px;">
        <p style="margin-bottom:12px;color:var(--gray);">These players are automatically tracked in live games. When their scoring falls below 60% of expected pace, it triggers a mean reversion signal. Tracks Q1 pace and halftime pace separately.</p>
        <table>
          <thead><tr><th>Player</th><th>Team</th><th>Season PPG</th><th>Q1 Expected</th><th>Half Expected</th><th>Signal (&lt;60%)</th><th>Actions</th></tr></thead>
          <tbody id="star-db-body"></tbody>
        </table>
        <div style="margin-top:12px;">
          <div class="form-grid" style="max-width:800px;">
            <div class="form-group"><label>Player Name</label><input type="text" id="add-star-name" placeholder="e.g., LeBron James" /></div>
            <div class="form-group"><label>Team (Abbr)</label><input type="text" id="add-star-team" placeholder="e.g., LAL" /></div>
            <div class="form-group"><label>Season PPG</label><input type="number" id="add-star-ppg" placeholder="e.g., 28.5" step="0.1" /></div>
            <div class="form-group" style="justify-content:flex-end;"><button class="btn btn-green" onclick="addStar()">Add Player</button></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Current Game Star Status</div>
      <div class="card-body">
        <table>
          <thead><tr><th>Player</th><th>Game</th><th>Current Pts</th><th>Q1 Pace</th><th>Half Pace</th><th>Overall Pace %</th><th>Period</th><th>Signal</th></tr></thead>
          <tbody id="live-star-status"><tr><td colspan="8" class="empty-state">Star player stats will populate when live games are running.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== BET LOG TAB ==================== -->
  <div class="tab-content" id="content-log">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Total Bets</div><div class="stat-value" id="log-total">0</div></div>
      <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value" id="log-winrate">-</div></div>
      <div class="stat-card"><div class="stat-label">Net Units</div><div class="stat-value" id="log-net-units">0</div></div>
      <div class="stat-card"><div class="stat-label">ROI</div><div class="stat-value" id="log-roi">-</div></div>
      <div class="stat-card"><div class="stat-label">Streak</div><div class="stat-value" id="log-streak">-</div></div>
    </div>
    <div class="card">
      <div class="card-header"><span>All Bets</span><div><button class="btn btn-outline btn-sm" onclick="exportLog()">Export CSV</button> <button class="btn btn-red btn-sm" onclick="clearLog()">Clear All</button></div></div>
      <div class="card-body">
        <table><thead><tr><th>Date</th><th>Strategy</th><th>Game</th><th>Side</th><th>Line/Price</th><th>Units</th><th>Result</th><th>Profit</th><th>Actions</th></tr></thead>
        <tbody id="bet-log-body"><tr><td colspan="9" class="empty-state">No bets logged yet.</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- ==================== BANKROLL TAB ==================== -->
  <div class="tab-content" id="content-bankroll">
    <div class="card">
      <div class="card-header">Bankroll Settings</div>
      <div class="card-body">
        <div class="form-grid" style="max-width:600px;">
          <div class="form-group"><label>Starting Bankroll ($)</label><input type="number" id="bankroll-start" placeholder="1000" onchange="updateBankroll()" /></div>
          <div class="form-group"><label>Current Bankroll ($)</label><input type="number" id="bankroll-current" placeholder="1050" onchange="updateBankroll()" /></div>
        </div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">1 Unit (1%)</div><div class="stat-value" id="br-unit">-</div></div>
      <div class="stat-card"><div class="stat-label">Max Bet (2%)</div><div class="stat-value" id="br-max">-</div></div>
      <div class="stat-card"><div class="stat-label">Max Daily (5u)</div><div class="stat-value" id="br-daily">-</div></div>
      <div class="stat-card"><div class="stat-label">P/L</div><div class="stat-value" id="br-pl">-</div></div>
      <div class="stat-card"><div class="stat-label">P/L %</div><div class="stat-value" id="br-pl-pct">-</div></div>
    </div>
    <div class="card">
      <div class="card-header">Rules</div>
      <div class="card-body" style="font-size:14px;line-height:1.8;">
        <p><strong>Standard:</strong> 1 unit &bull; <strong>High conviction:</strong> 1.5 units &bull; <strong>Maximum:</strong> 2 units</p>
        <p style="margin-top:8px;padding:10px;background:#fff3cd;border-radius:6px;"><strong>Stop-loss:</strong> 3 straight losses = 1 day off. 20% drawdown from peak = cut to 0.5% units.</p>
      </div>
    </div>
  </div>
</div>

<!-- LOG BET MODAL -->
<div class="modal-overlay" id="logModal">
  <div class="modal">
    <h3>Log This Bet</h3>
    <div class="form-grid">
      <div class="form-group"><label>Game</label><input type="text" id="modal-game" /></div>
      <div class="form-group"><label>Side</label><input type="text" id="modal-side" /></div>
      <div class="form-group"><label>Strategy</label><select id="modal-strategy"><option>Mean Reversion - ML</option><option>Mean Reversion - Spread</option><option>3PT Regression</option><option>Mean Reversion</option></select></div>
      <div class="form-group"><label>Line / Price</label><input type="text" id="modal-price" /></div>
      <div class="form-group"><label>Units</label><input type="number" id="modal-units" value="1" step="0.5" min="0.5" max="2" /></div>
      <div class="form-group"><label>Notes</label><input type="text" id="modal-notes" /></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-green" onclick="confirmLogBet()">Log Bet</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container" style="position:fixed;top:80px;right:24px;z-index:150;display:flex;flex-direction:column;gap:8px;"></div>

<script>
// ==================== STAR PLAYERS DATABASE (23+ PPG) ====================
const DEFAULT_STARS = [
  { name: "Shai Gilgeous-Alexander", team: "OKC", ppg: 32.2 },
  { name: "Giannis Antetokounmpo", team: "MIL", ppg: 31.5 },
  { name: "Nikola Jokic", team: "DEN", ppg: 29.0 },
  { name: "Luka Doncic", team: "DAL", ppg: 28.1 },
  { name: "Jayson Tatum", team: "BOS", ppg: 27.8 },
  { name: "Joel Embiid", team: "PHI", ppg: 27.6 },
  { name: "Kevin Durant", team: "PHX", ppg: 27.3 },
  { name: "Devin Booker", team: "PHX", ppg: 27.2 },
  { name: "Anthony Edwards", team: "MIN", ppg: 27.0 },
  { name: "De'Aaron Fox", team: "SAC", ppg: 26.8 },
  { name: "Donovan Mitchell", team: "CLE", ppg: 26.5 },
  { name: "Jalen Brunson", team: "NYK", ppg: 26.3 },
  { name: "Anthony Davis", team: "LAL", ppg: 25.7 },
  { name: "Karl-Anthony Towns", team: "NYK", ppg: 25.3 },
  { name: "Cade Cunningham", team: "DET", ppg: 24.8 },
  { name: "Trae Young", team: "ATL", ppg: 24.3 },
  { name: "Damian Lillard", team: "MIL", ppg: 24.0 },
  { name: "Tyrese Maxey", team: "PHI", ppg: 25.5 },
  { name: "Jaylen Brown", team: "BOS", ppg: 23.8 },
  { name: "LeBron James", team: "LAL", ppg: 23.5 },
  { name: "Jaren Jackson Jr.", team: "MEM", ppg: 23.3 },
  { name: "Tyrese Haliburton", team: "IND", ppg: 23.2 },
  { name: "Zion Williamson", team: "NOP", ppg: 23.0 },
];

// NBA team name mapping
const TEAM_MAP = {
  'Atlanta Hawks':'ATL','Boston Celtics':'BOS','Brooklyn Nets':'BKN','Charlotte Hornets':'CHA',
  'Chicago Bulls':'CHI','Cleveland Cavaliers':'CLE','Dallas Mavericks':'DAL','Denver Nuggets':'DEN',
  'Detroit Pistons':'DET','Golden State Warriors':'GSW','Houston Rockets':'HOU','Indiana Pacers':'IND',
  'LA Clippers':'LAC','Los Angeles Clippers':'LAC','Los Angeles Lakers':'LAL','Memphis Grizzlies':'MEM',
  'Miami Heat':'MIA','Milwaukee Bucks':'MIL','Minnesota Timberwolves':'MIN','New Orleans Pelicans':'NOP',
  'New York Knicks':'NYK','Oklahoma City Thunder':'OKC','Orlando Magic':'ORL','Philadelphia 76ers':'PHI',
  'Phoenix Suns':'PHX','Portland Trail Blazers':'POR','Sacramento Kings':'SAC','San Antonio Spurs':'SAS',
  'Toronto Raptors':'TOR','Utah Jazz':'UTA','Washington Wizards':'WAS',
};

function shortName(name) { return TEAM_MAP[name] || name.split(' ').pop().substring(0,3).toUpperCase(); }

// ==================== STATE ====================
let state = {
  betLog: JSON.parse(localStorage.getItem('betLog') || '[]'),
  bankroll: JSON.parse(localStorage.getItem('bankroll') || '{"start":0,"current":0}'),
  stars: JSON.parse(localStorage.getItem('starPlayers') || 'null') || DEFAULT_STARS,
  liveGames: [],
  autoRefresh: false,
  refreshTimer: null,
  countdownTimer: null,
  quarterAlerts: JSON.parse(localStorage.getItem('quarterAlerts') || '[]'),
  // Track quarter states so we only alert once per quarter-end
  lastKnownPeriods: {},
  // Track 3PT data per-quarter per-team for quarter-end detection
  prevTeamData: {},
};

// ==================== INIT ====================
document.getElementById('bankroll-start').value = state.bankroll.start || '';
document.getElementById('bankroll-current').value = state.bankroll.current || '';
updateBankroll();
renderBetLog();
renderStarDB();
renderQtrAlerts();

// ==================== TABS ====================
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('content-'+tab).classList.add('active');
}

// ==================== AUTO REFRESH ====================
function toggleAutoRefresh() {
  state.autoRefresh = !state.autoRefresh;
  const btn = document.getElementById('autoRefreshBtn');
  const dot = document.getElementById('autoRefreshDot');
  const label = document.getElementById('autoRefreshLabel');
  if (state.autoRefresh) {
    btn.textContent = 'Stop'; btn.className = 'btn btn-sm btn-red';
    dot.className = 'dot'; label.textContent = 'ON';
    fetchESPNScoreboard();
    startCountdown();
  } else {
    btn.textContent = 'Start'; btn.className = 'btn btn-sm btn-green';
    dot.className = 'dot off'; label.textContent = 'OFF';
    clearInterval(state.refreshTimer);
    clearInterval(state.countdownTimer);
    document.getElementById('countdownFill').style.width = '100%';
  }
}

function startCountdown() {
  const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
  let remaining = interval;
  clearInterval(state.refreshTimer);
  clearInterval(state.countdownTimer);
  state.refreshTimer = setInterval(() => {
    if (state.autoRefresh) { fetchESPNScoreboard(); remaining = interval; }
  }, interval);
  state.countdownTimer = setInterval(() => {
    remaining -= 1000;
    const pct = Math.max(0, remaining / interval * 100);
    document.getElementById('countdownFill').style.width = pct + '%';
  }, 1000);
}

function updateRefreshInterval() { if (state.autoRefresh) startCountdown(); }

// ==================== PACE HELPERS ====================
// Q1 expected = PPG * (12/48) = PPG / 4
// Half expected = PPG * (24/48) = PPG / 2
// Signal fires when actual < 60% of expected at that point
function getQ1Expected(ppg) { return ppg * (12 / 48); }
function getHalfExpected(ppg) { return ppg * (24 / 48); }
function getExpectedByTime(ppg, gameMinutesElapsed) { return ppg * (gameMinutesElapsed / 48); }

// ==================== BET RECOMMENDATION ENGINE ====================
// Uses live margin + time remaining to decide: ML, Spread, or Watch
// Signal detection is unchanged ‚Äî this only runs AFTER a signal fires
function getRecommendation(awayScore, homeScore, awayAbbr, homeAbbr, period, clock, signalLevel) {
  const margin = Math.abs(homeScore - awayScore);
  const tied = homeScore === awayScore;
  const trailingTeam = tied ? null : (awayScore < homeScore ? awayAbbr : homeAbbr);
  const leadingTeam = tied ? null : (awayScore < homeScore ? homeAbbr : awayAbbr);

  // Calculate time remaining
  const clockMin = parseFloat(clock?.split(':')[0] || 12);
  const clockSec = parseFloat(clock?.split(':')[1] || 0);
  const gameMinElapsed = (period - 1) * 12 + (12 - clockMin - clockSec / 60);
  const gameMinRemaining = Math.max(0, 48 - gameMinElapsed);

  // Default: WATCH
  let rec = { type: 'WATCH', side: null, spreadLine: '', units: 0, reasoning: '', margin: margin, minRemaining: Math.round(gameMinRemaining) };

  // OT or <3 min left ‚Üí always WATCH
  if (period >= 5) {
    rec.reasoning = 'Overtime ‚Äî too volatile for mean reversion plays.';
    return rec;
  }
  if (gameMinRemaining < 3) {
    rec.reasoning = 'Under 3 min remaining ‚Äî not enough time for reversion.';
    return rec;
  }

  // Only generate actionable recs for strong signals (level 2)
  if (signalLevel < 2) {
    rec.reasoning = 'Developing signal ‚Äî monitor, no action yet.';
    return rec;
  }

  // Determine base recommendation from margin
  let type, units;
  if (margin <= 5) {
    type = 'ML'; units = 1.5;
  } else if (margin <= 15) {
    type = 'SPREAD'; units = margin <= 10 ? 1.5 : 1;
  } else if (margin <= 20) {
    type = 'SPREAD'; units = 1;
  } else {
    // 21+ pts ‚Äî too far gone
    rec.reasoning = `Down ${margin} pts ‚Äî margin too large for mean reversion play.`;
    return rec;
  }

  // Time adjustment: <6 min remaining ‚Üí downgrade one tier
  if (gameMinRemaining < 6) {
    if (type === 'ML') {
      type = 'SPREAD'; // ML ‚Üí SPREAD
    } else if (margin > 15) {
      // cautious SPREAD ‚Üí WATCH
      rec.reasoning = `Down ${margin} with only ${Math.round(gameMinRemaining)} min left ‚Äî not enough time.`;
      return rec;
    }
    units = Math.min(units, 1); // cap units when time is short
  }

  // Build the recommendation
  const side = tied ? awayAbbr : trailingTeam; // if tied, pick away team as default
  const spreadLine = type === 'SPREAD' ? `+${margin}` : '';
  const timeStr = Math.round(gameMinRemaining);

  let reasoning = '';
  if (type === 'ML') {
    reasoning = `${side} only down ${margin} pts with ${timeStr} min left ‚Äî close enough for ML.`;
    if (tied) reasoning = `Game tied with ${timeStr} min left ‚Äî ML play.`;
  } else {
    reasoning = `${side} down ${margin} with ${timeStr} min left ‚Äî take the spread for mean reversion.`;
    if (margin > 15) reasoning = `${side} down ${margin} ‚Äî cautious spread play, large deficit.`;
  }

  rec = { type, side, spreadLine, units, reasoning, margin, minRemaining: timeStr };
  return rec;
}

// ==================== QUARTER-END DETECTION ====================
function checkQuarterEnd(gameId, teamAbbr, currentPeriod, threePtPct, threePtMade, threePtAtt, gameLabel) {
  const key = `${gameId}_${teamAbbr}`;
  const prevPeriod = state.lastKnownPeriods[key] || 0;

  // Detect quarter transition: period increased, meaning previous quarter just ended
  if (currentPeriod > prevPeriod && prevPeriod > 0) {
    const endedQuarter = prevPeriod;
    const prev = state.prevTeamData[key];
    if (prev) {
      // Calculate the quarter-specific shooting: current cumulative - previous cumulative
      const qMade = (parseInt(threePtMade) || 0) - (prev.made || 0);
      const qAtt = (parseInt(threePtAtt) || 0) - (prev.att || 0);
      const qPct = qAtt > 0 ? (qMade / qAtt * 100) : 0;

      if (qPct >= 50 && qAtt >= 4) {
        // QUARTER-END ALERT!
        const alert = {
          id: Date.now() + Math.random(),
          time: new Date().toLocaleTimeString(),
          team: teamAbbr,
          quarter: endedQuarter,
          pct: qPct.toFixed(1),
          made: qMade,
          att: qAtt,
          game: gameLabel,
        };
        state.quarterAlerts.unshift(alert);
        localStorage.setItem('quarterAlerts', JSON.stringify(state.quarterAlerts));
        renderQtrAlerts();
        showQuarterToast(alert);
      }
    }
  }

  // Update tracking
  state.lastKnownPeriods[key] = currentPeriod;
  state.prevTeamData[key] = {
    made: parseInt(threePtMade) || 0,
    att: parseInt(threePtAtt) || 0,
    period: currentPeriod,
  };
}

function showQuarterToast(alert) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'quarter-alert-toast';
  toast.innerHTML = `
    <div class="toast-title">&#x1F6A8; Q${alert.quarter} END ALERT - ${alert.team}</div>
    <div class="toast-body">${alert.team} shot ${alert.pct}% from 3 (${alert.made}/${alert.att}) in Q${alert.quarter}!<br>${alert.game} - Unsustainable rate, mean reversion play.</div>
  `;
  toast.onclick = () => toast.remove();
  container.appendChild(toast);
  // Auto-remove after 13s
  setTimeout(() => { if (toast.parentNode) toast.remove(); }, 13000);

  // Also update the quarter-alerts badge
  const badge = document.getElementById('threept-badge');
  const count = state.quarterAlerts.length;
  if (count > 0) { badge.style.display = 'inline'; badge.textContent = count; }
}

function renderQtrAlerts() {
  const tbody = document.getElementById('qtr-alerts-body');
  if (!state.quarterAlerts.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No quarter-end alerts yet. Triggers when a team ends a quarter shooting 50%+ from 3.</td></tr>';
    document.getElementById('threept-qtr-alerts').textContent = '0';
    return;
  }
  tbody.innerHTML = state.quarterAlerts.map(a => `<tr>
    <td>${a.time}</td>
    <td><strong>${a.team}</strong></td>
    <td>Q${a.quarter}</td>
    <td style="color:var(--red);font-weight:800;">${a.pct}%</td>
    <td>${a.made}/${a.att}</td>
    <td>${a.game}</td>
    <td><button class="btn btn-purple btn-sm" onclick="openLogModal('${a.game}','3PT Q${a.quarter} Regression','3PT Regression',1)">Log Bet</button></td>
  </tr>`).join('');
  document.getElementById('threept-qtr-alerts').textContent = state.quarterAlerts.length;
}

function clearQtrAlerts() {
  if (confirm('Clear all quarter alerts?')) {
    state.quarterAlerts = [];
    localStorage.setItem('quarterAlerts', '[]');
    renderQtrAlerts();
    document.getElementById('threept-badge').style.display = 'none';
  }
}

// ==================== ESPN SCOREBOARD (NO AUTH) ====================
async function fetchESPNScoreboard() {
  const grid = document.getElementById('live-games-grid');
  const threeptGrid = document.getElementById('threept-grid');
  try {
    const res = await fetch('https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard');
    if (!res.ok) throw new Error('ESPN returned ' + res.status);
    const data = await res.json();
    const events = data.events || [];

    document.getElementById('live-last-update').textContent = new Date().toLocaleTimeString();

    const liveEvents = events.filter(e => {
      const s = e.status?.type?.state;
      return s === 'in' || s === 'pre';
    });
    const inProgress = events.filter(e => e.status?.type?.state === 'in');
    document.getElementById('live-games-count').textContent = inProgress.length;

    if (liveEvents.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3C0;</div><p>No live or upcoming NBA games right now.</p></div>`;
      threeptGrid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3AF;</div><p>No live games for 3PT tracking.</p></div>`;
      return;
    }

    let threePtSignals = 0, starSignals = 0, combinedSignals = 0;
    let hotTeams = 0, warmTeams = 0;
    let cards = '';
    let threeptCards = '';

    for (const event of liveEvents) {
      const comp = event.competitions?.[0];
      if (!comp) continue;
      const away = comp.competitors?.find(c => c.homeAway === 'away');
      const home = comp.competitors?.find(c => c.homeAway === 'home');
      if (!away || !home) continue;

      const gameId = event.id;
      const awayAbbr = away.team?.abbreviation || shortName(away.team?.displayName||'');
      const homeAbbr = home.team?.abbreviation || shortName(home.team?.displayName||'');
      const awayScore = parseInt(away.score) || 0;
      const homeScore = parseInt(home.score) || 0;
      const isLive = event.status?.type?.state === 'in';
      const period = event.status?.period || 0;
      const clock = event.status?.displayClock || '';
      const statusDetail = event.status?.type?.shortDetail || '';
      const gameLabel = `${awayAbbr} @ ${homeAbbr}`;

      const awayRecords = away.records?.[0]?.summary || '';
      const homeRecords = home.records?.[0]?.summary || '';

      // Extract team stats
      let awayStats = {}, homeStats = {};
      (away.statistics || []).forEach(s => { awayStats[s.name] = s.displayValue; });
      (home.statistics || []).forEach(s => { homeStats[s.name] = s.displayValue; });

      // 3PT data
      let awayFG3 = awayStats.threePointFieldGoalPct || awayStats.threePointPct || '-';
      let homeFG3 = homeStats.threePointFieldGoalPct || homeStats.threePointPct || '-';
      let awayFG3Made = awayStats.threePointFieldGoalsMade || '-';
      let awayFG3Att = awayStats.threePointFieldGoalsAttempted || '-';
      let homeFG3Made = homeStats.threePointFieldGoalsMade || '-';
      let homeFG3Att = homeStats.threePointFieldGoalsAttempted || '-';

      // Check quarter-end transitions for 3PT alerts
      if (isLive) {
        checkQuarterEnd(gameId, awayAbbr, period, awayFG3, awayFG3Made, awayFG3Att, gameLabel);
        checkQuarterEnd(gameId, homeAbbr, period, homeFG3, homeFG3Made, homeFG3Att, gameLabel);
      }

      // Get leaders
      let awayLeaders = [], homeLeaders = [];
      (comp.competitors || []).forEach(c => {
        const leaders = c.leaders || [];
        leaders.forEach(cat => {
          if (cat.name === 'points' || cat.displayName === 'Points') {
            (cat.leaders || []).forEach(l => {
              const entry = { name: l.athlete?.shortName || l.athlete?.displayName || '?', pts: parseFloat(l.value) || 0, team: c.homeAway === 'away' ? awayAbbr : homeAbbr };
              if (c.homeAway === 'away') awayLeaders.push(entry); else homeLeaders.push(entry);
            });
          }
        });
      });

      // SIGNAL DETECTION
      let signals = [];
      let signalLevel = 0;

      if (isLive) {
        // 3PT signal check
        const checkTeam3PT = (pct, made, att, teamAbbr) => {
          const pctNum = parseFloat(pct);
          const attNum = parseInt(att);
          const madeNum = parseInt(made);
          if (pctNum >= 50 && attNum >= 8) {
            signals.push({ type: '3pt', text: `${teamAbbr} shooting ${pctNum.toFixed(0)}% from 3 (${madeNum}/${attNum}) - UNSUSTAINABLE. League avg is 36.5%.`, level: 2 });
            threePtSignals++;
            hotTeams++;
            return true;
          } else if (pctNum >= 45 && attNum >= 6) {
            signals.push({ type: '3pt', text: `${teamAbbr} shooting ${pctNum.toFixed(0)}% from 3 (${madeNum}/${attNum}) - elevated, watch for more.`, level: 1 });
            warmTeams++;
            return false;
          }
          return false;
        };

        checkTeam3PT(awayFG3, awayFG3Made, awayFG3Att, awayAbbr);
        checkTeam3PT(homeFG3, homeFG3Made, homeFG3Att, homeAbbr);

        // Star player pace check - NOW 60% THRESHOLD
        const clockMin = parseFloat(clock?.split(':')[0] || 12);
        const clockSec = parseFloat(clock?.split(':')[1] || 0);
        const gameMinutesElapsed = (period - 1) * 12 + (12 - clockMin - clockSec/60);
        const gamePct = Math.min(gameMinutesElapsed / 48, 1);

        [...awayLeaders, ...homeLeaders].forEach(leader => {
          const star = state.stars.find(s => leader.name.toLowerCase().includes(s.name.split(' ').pop().toLowerCase()) && s.team === leader.team);
          if (star) {
            const expectedPts = getExpectedByTime(star.ppg, gameMinutesElapsed);
            const paceRatio = expectedPts > 0 ? leader.pts / expectedPts : 1;

            // Q1 pace check (during Q1 or after): if in Q1 and below 60% of Q1 expected
            const q1Expected = getQ1Expected(star.ppg);
            const halfExpected = getHalfExpected(star.ppg);

            if (paceRatio < 0.6 && gamePct >= 0.2 && period <= 3) {
              let context = '';
              if (period === 1) {
                context = ` Q1 expected: ${q1Expected.toFixed(0)} pts.`;
              } else if (period === 2) {
                context = ` Half expected: ${halfExpected.toFixed(0)} pts.`;
              }
              signals.push({ type: 'star', text: `${leader.name} has ${leader.pts} pts (expected ~${expectedPts.toFixed(0)} by now at ${star.ppg} PPG pace, 60% threshold = ${(expectedPts*0.6).toFixed(0)} pts).${context} Mean reversion candidate.`, level: 2 });
              starSignals++;
            } else if (paceRatio < 0.75 && gamePct >= 0.2) {
              signals.push({ type: 'star', text: `${leader.name} at ${leader.pts} pts, behind ${star.ppg} PPG pace (expected ~${expectedPts.toFixed(0)}).`, level: 1 });
            }
          }
        });

        // Combined signal
        const has3pt = signals.some(s => s.type === '3pt' && s.level === 2);
        const hasStar = signals.some(s => s.type === 'star' && s.level === 2);
        if (has3pt && hasStar) { signalLevel = 2; combinedSignals++; }
        else if (has3pt || hasStar) { signalLevel = 1; }
      }

      const cardClass = signalLevel === 2 ? 'signal-fire' : signalLevel === 1 ? 'signal-warn' : '';
      const headerClass = isLive ? 'game-card-header live-pulse' : 'game-card-header';

      // Build stat bars for 3PT
      const build3ptBar = (pct, made, att, teamAbbr) => {
        const p = parseFloat(pct) || 0;
        const barClass = p >= 50 ? 'hot' : p >= 36.5 ? 'normal' : 'cold';
        const width = Math.min(p, 100);
        return `<div class="stat-bar-row">
          <span class="stat-bar-label">${teamAbbr} 3PT%</span>
          <div class="stat-bar-track">
            <div class="stat-bar-fill ${barClass}" style="width:${width}%">${p.toFixed(0)}%</div>
            <div class="stat-bar-avg" style="left:36.5%" data-label="avg 36.5%"></div>
          </div>
          <span class="stat-bar-value">${made||'-'}/${att||'-'}</span>
        </div>`;
      };

      // LIVE GAMES CARD
      cards += `<div class="game-card ${cardClass}">
        <div class="${headerClass}">
          <span>${isLive ? 'LIVE' : 'UPCOMING'} ${statusDetail}</span>
          <span>${new Date(event.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div class="game-card-body">
          <div class="game-teams">
            <div class="team-block">
              <div class="team-name">${awayAbbr}</div>
              <div class="team-record">${awayRecords}</div>
              <div class="team-score">${isLive ? awayScore : '-'}</div>
            </div>
            <div class="vs-block">
              <div class="vs-text">@</div>
              ${isLive ? `<div class="game-period">Q${period} ${clock}</div>` : ''}
            </div>
            <div class="team-block">
              <div class="team-name">${homeAbbr}</div>
              <div class="team-record">${homeRecords}</div>
              <div class="team-score">${isLive ? homeScore : '-'}</div>
            </div>
          </div>
          ${isLive ? `<div class="stat-bars">
            ${build3ptBar(awayFG3, awayFG3Made, awayFG3Att, awayAbbr)}
            ${build3ptBar(homeFG3, homeFG3Made, homeFG3Att, homeAbbr)}
            ${awayLeaders.length ? `<div class="stat-bar-row"><span class="stat-bar-label">${awayAbbr} leader</span><span style="flex:1;font-weight:700;">${awayLeaders[0]?.name}: ${awayLeaders[0]?.pts} pts</span></div>` : ''}
            ${homeLeaders.length ? `<div class="stat-bar-row"><span class="stat-bar-label">${homeAbbr} leader</span><span style="flex:1;font-weight:700;">${homeLeaders[0]?.name}: ${homeLeaders[0]?.pts} pts</span></div>` : ''}
          </div>` : ''}
          ${signals.length > 0 ? (() => {
            const rec = getRecommendation(awayScore, homeScore, awayAbbr, homeAbbr, period, clock, signalLevel);
            const panelClass = signalLevel === 2
              ? (rec.type === 'WATCH' ? 'strong' : 'fire')
              : 'strong';
            const titleClass = signalLevel === 2 ? 'fire' : 'warn';
            let titleText, recDetail, betBtn;
            if (signalLevel < 2) {
              titleText = 'DEVELOPING SIGNAL';
              recDetail = '';
              betBtn = '';
            } else if (rec.type === 'ML') {
              titleText = `MEAN REVERSION &#x2014; ML PLAY: ${rec.side} ML`;
              recDetail = `<div class="signal-detail" style="margin-top:4px;font-weight:700;color:#155724;">&#x1F4B0; ${rec.reasoning}</div>`;
              betBtn = `<div style="margin-top:6px;"><button class="btn btn-orange btn-sm" onclick="openLogModal('${awayAbbr} @ ${homeAbbr}','${rec.side} ML','Mean Reversion - ML',${rec.units})">Log ML Bet (${rec.units}u)</button></div>`;
            } else if (rec.type === 'SPREAD') {
              titleText = `MEAN REVERSION &#x2014; SPREAD PLAY: ${rec.side} ${rec.spreadLine}`;
              recDetail = `<div class="signal-detail" style="margin-top:4px;font-weight:700;color:#4a235a;">&#x1F3AF; ${rec.reasoning}</div>`;
              betBtn = `<div style="margin-top:6px;"><button class="btn btn-purple btn-sm" onclick="openLogModal('${awayAbbr} @ ${homeAbbr}','${rec.side} ${rec.spreadLine}','Mean Reversion - Spread',${rec.units})">Log Spread Bet (${rec.units}u)</button></div>`;
            } else {
              titleText = 'MEAN REVERSION SIGNAL &#x2014; WATCH';
              recDetail = `<div class="signal-detail" style="margin-top:4px;font-weight:700;color:#6c757d;">&#x1F440; ${rec.reasoning}</div>`;
              betBtn = '';
            }
            return `<div class="signal-panel ${panelClass}">
              <div class="signal-title ${titleClass}">${titleText}</div>
              ${signals.map(s => `<div class="signal-detail">${s.level === 2 ? '&#x1F525;' : '&#x26A0;&#xFE0F;'} ${s.text}</div>`).join('')}
              ${recDetail}
              ${betBtn}
            </div>`;
          })() : ''}
          ${isLive && signals.length === 0 ? `<div style="text-align:center;padding:6px;font-size:11px;color:var(--gray);">No signals detected</div>` : ''}
        </div>
      </div>`;

      // ==================== 3PT TRACKER CARD ====================
      if (isLive) {
        const awayPct = parseFloat(awayFG3) || 0;
        const homePct = parseFloat(homeFG3) || 0;
        const awayHot = awayPct >= 50 && parseInt(awayFG3Att) >= 8;
        const homeHot = homePct >= 50 && parseInt(homeFG3Att) >= 8;
        const awayWarm = awayPct >= 45 && parseInt(awayFG3Att) >= 6 && !awayHot;
        const homeWarm = homePct >= 45 && parseInt(homeFG3Att) >= 6 && !homeHot;
        const cardBorder = (awayHot || homeHot) ? 'hot-card' : (awayWarm || homeWarm) ? 'warm-card' : '';

        // Build quarter boxes - we show cumulative per-quarter estimate
        // Since ESPN only gives cumulative, we show the overall trend with quarter markers
        const buildQtrBoxes = (teamAbbr, pct, made, att) => {
          const p = parseFloat(pct) || 0;
          const m = parseInt(made) || 0;
          const a = parseInt(att) || 0;
          let boxes = '';
          for (let q = 1; q <= 4; q++) {
            const isActive = q === period;
            const isPast = q < period;
            if (isPast || isActive) {
              // For the active/past quarters, show cumulative shooting
              const qClass = isActive ? 'active-q' : '';
              const hotClass = p >= 50 && a >= 8 && isActive ? 'hot-q' : qClass;
              const valClass = p >= 50 ? 'hot-val' : 'normal-val';
              boxes += `<div class="qtr-box ${hotClass}">
                <div class="qtr-label">Q${q}${isActive ? ' *' : ''}</div>
                <div class="qtr-value ${isActive ? valClass : 'normal-val'}">${isActive ? p.toFixed(0)+'%' : '-'}</div>
                <div class="qtr-detail">${isActive ? m+'/'+a : 'done'}</div>
              </div>`;
            } else {
              boxes += `<div class="qtr-box"><div class="qtr-label">Q${q}</div><div class="qtr-value normal-val">-</div><div class="qtr-detail">upcoming</div></div>`;
            }
          }
          return boxes;
        };

        const buildTeamRow = (teamAbbr, pct, made, att, isHot, isWarm) => {
          const p = parseFloat(pct) || 0;
          const statusBadge = isHot ? '<span class="signal-badge signal-fire">UNSUSTAINABLE</span>'
            : isWarm ? '<span class="signal-badge signal-moderate">ELEVATED</span>'
            : '<span class="signal-badge signal-none">Normal</span>';
          return `<div style="margin-bottom:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-weight:800;font-size:15px;color:var(--navy);">${teamAbbr}</span>
              ${statusBadge}
            </div>
            ${build3ptBar(pct, made, att, teamAbbr)}
            <div class="qtr-grid">${buildQtrBoxes(teamAbbr, pct, made, att)}</div>
          </div>`;
        };

        threeptCards += `<div class="three-pt-card ${cardBorder}">
          <div class="three-pt-card-header">
            <span>${gameLabel}</span>
            <span>Q${period} ${clock}</span>
          </div>
          <div class="three-pt-card-body">
            ${buildTeamRow(awayAbbr, awayFG3, awayFG3Made, awayFG3Att, awayHot, awayWarm)}
            ${buildTeamRow(homeAbbr, homeFG3, homeFG3Made, homeFG3Att, homeHot, homeWarm)}
            ${(awayHot || homeHot) ? `<div style="text-align:center;margin-top:8px;"><button class="btn btn-purple btn-sm" onclick="openLogModal('${gameLabel}','3PT Regression','3PT Regression',1)">Log 3PT Regression Bet</button></div>` : ''}
          </div>
        </div>`;
      }
    }

    grid.innerHTML = cards || `<div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3C0;</div><p>No games to display.</p></div>`;
    threeptGrid.innerHTML = threeptCards || `<div class="empty-state" style="grid-column:1/-1;"><div class="icon">&#x1F3AF;</div><p>No live games for 3PT tracking.</p></div>`;

    // Update counts
    document.getElementById('live-3pt-signals').textContent = threePtSignals;
    document.getElementById('live-star-signals').textContent = starSignals;
    document.getElementById('live-combined-signals').textContent = combinedSignals;
    document.getElementById('threept-hot-count').textContent = hotTeams;
    document.getElementById('threept-warm-count').textContent = warmTeams;

    if (combinedSignals > 0 || threePtSignals > 0 || starSignals > 0) {
      const totalSigs = threePtSignals + starSignals;
      document.getElementById('live-badge').style.display = 'inline';
      document.getElementById('live-badge').textContent = totalSigs;
    } else {
      document.getElementById('live-badge').style.display = 'none';
    }

    if (hotTeams > 0) {
      document.getElementById('threept-badge').style.display = 'inline';
      document.getElementById('threept-badge').textContent = hotTeams;
    }

    // Update star tracker
    updateStarTracker(events);

  } catch (err) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p style="color:var(--red);">Error: ${err.message}. ESPN may be temporarily rate-limiting. Try again in 30s.</p></div>`;
  }
}

// ==================== STAR TRACKER UPDATE ====================
function updateStarTracker(events) {
  const tbody = document.getElementById('live-star-status');
  let rows = '';

  for (const event of events) {
    if (event.status?.type?.state !== 'in') continue;
    const comp = event.competitions?.[0];
    if (!comp) continue;

    const period = event.status?.period || 1;
    const clock = event.status?.displayClock || '12:00';
    const clockMin = parseFloat(clock?.split(':')[0] || 12);
    const clockSec = parseFloat(clock?.split(':')[1] || 0);
    const gameMinutesElapsed = (period - 1) * 12 + (12 - clockMin - clockSec/60);
    const gamePct = Math.min(gameMinutesElapsed / 48, 1);

    for (const team of (comp.competitors || [])) {
      const teamAbbr = team.team?.abbreviation || '';
      const awayT = comp.competitors?.find(c => c.homeAway === 'away');
      const homeT = comp.competitors?.find(c => c.homeAway === 'home');
      const gameLabel = `${awayT?.team?.abbreviation||''} @ ${homeT?.team?.abbreviation||''}`;

      for (const cat of (team.leaders || [])) {
        if (cat.name !== 'points') continue;
        for (const leader of (cat.leaders || [])) {
          const name = leader.athlete?.shortName || leader.athlete?.displayName || '';
          const pts = parseFloat(leader.value) || 0;
          const star = state.stars.find(s => name.toLowerCase().includes(s.name.split(' ').pop().toLowerCase()) && s.team === teamAbbr);
          if (!star) continue;

          const expected = getExpectedByTime(star.ppg, gameMinutesElapsed);
          const paceRatio = expected > 0 ? (pts / expected * 100) : 100;
          const q1Expected = getQ1Expected(star.ppg);
          const halfExpected = getHalfExpected(star.ppg);

          // Q1 pace display
          let q1PaceText = '-';
          if (period >= 2) {
            // After Q1, we only know cumulative - show if pts < 60% of Q1 expected
            q1PaceText = `${q1Expected.toFixed(1)} exp`;
          } else if (period === 1) {
            const q1Pct = q1Expected > 0 ? (pts / q1Expected * 100) : 100;
            const q1Color = q1Pct < 60 ? 'var(--red)' : q1Pct < 80 ? 'var(--orange)' : 'var(--green)';
            q1PaceText = `<span style="color:${q1Color};font-weight:700;">${q1Pct.toFixed(0)}%</span> of ${q1Expected.toFixed(1)}`;
          }

          // Half pace display
          let halfPaceText = '-';
          if (period >= 3) {
            halfPaceText = `${halfExpected.toFixed(1)} exp`;
          } else if (period === 2 || (period === 1 && gameMinutesElapsed > 0)) {
            const halfPct = halfExpected > 0 ? (pts / halfExpected * 100) : 100;
            const halfColor = halfPct < 60 ? 'var(--red)' : halfPct < 80 ? 'var(--orange)' : 'var(--green)';
            halfPaceText = `<span style="color:${halfColor};font-weight:700;">${halfPct.toFixed(0)}%</span> of ${halfExpected.toFixed(1)}`;
          }

          const fillColor = paceRatio < 60 ? 'var(--red)' : paceRatio < 80 ? 'var(--orange)' : 'var(--green)';
          const signal = paceRatio < 60 && gamePct >= 0.2 && period <= 3 ? '<span class="signal-badge signal-fire">COLD - BET SIGNAL</span>'
                       : paceRatio < 75 ? '<span class="signal-badge signal-moderate">Below Pace</span>'
                       : '<span class="signal-badge signal-none">On Pace</span>';

          rows += `<tr class="star-row">
            <td><strong>${name}</strong><br><span style="font-size:10px;color:var(--gray);">${star.ppg} PPG avg</span></td>
            <td>${gameLabel}</td>
            <td style="font-size:18px;font-weight:800;">${pts}</td>
            <td>${q1PaceText}</td>
            <td>${halfPaceText}</td>
            <td><div class="pace-indicator"><div class="pace-fill" style="width:${Math.min(paceRatio,100)}%;background:${fillColor};"></div></div> ${paceRatio.toFixed(0)}%</td>
            <td>Q${period} ${clock}</td>
            <td>${signal}</td>
          </tr>`;
        }
      }
    }
  }

  tbody.innerHTML = rows || '<tr><td colspan="8" class="empty-state">No tracked stars in live games right now.</td></tr>';
}

// ==================== STAR DATABASE ====================
function renderStarDB() {
  const tbody = document.getElementById('star-db-body');
  tbody.innerHTML = state.stars.map((s, i) => {
    const q1Exp = getQ1Expected(s.ppg);
    const halfExp = getHalfExpected(s.ppg);
    return `<tr>
      <td><strong>${s.name}</strong></td>
      <td>${s.team}</td>
      <td>${s.ppg}</td>
      <td>${q1Exp.toFixed(1)} pts</td>
      <td>${halfExp.toFixed(1)} pts</td>
      <td>&lt;${(q1Exp * 0.6).toFixed(0)} pts Q1, &lt;${(halfExp * 0.6).toFixed(0)} pts half</td>
      <td><button class="btn btn-red btn-sm" onclick="removeStar(${i})">Remove</button></td>
    </tr>`;
  }).join('');
}

function addStar() {
  const name = document.getElementById('add-star-name').value.trim();
  const team = document.getElementById('add-star-team').value.trim().toUpperCase();
  const ppg = parseFloat(document.getElementById('add-star-ppg').value);
  if (!name || !team || isNaN(ppg)) { alert('Fill in all fields'); return; }
  state.stars.push({ name, team, ppg });
  localStorage.setItem('starPlayers', JSON.stringify(state.stars));
  renderStarDB();
  document.getElementById('add-star-name').value = '';
  document.getElementById('add-star-team').value = '';
  document.getElementById('add-star-ppg').value = '';
}

function removeStar(i) {
  state.stars.splice(i, 1);
  localStorage.setItem('starPlayers', JSON.stringify(state.stars));
  renderStarDB();
}

// ==================== BET LOG ====================
function openLogModal(game, side, strategy, units) {
  document.getElementById('modal-game').value = game;
  document.getElementById('modal-side').value = side || '';
  document.getElementById('modal-strategy').value = strategy || 'Mean Reversion - ML';
  document.getElementById('modal-price').value = '';
  document.getElementById('modal-units').value = units || 1;
  document.getElementById('modal-notes').value = '';
  document.getElementById('logModal').classList.add('active');
}
function closeModal() { document.getElementById('logModal').classList.remove('active'); }

function confirmLogBet() {
  state.betLog.push({ date: new Date().toLocaleDateString(), strategy: document.getElementById('modal-strategy').value, game: document.getElementById('modal-game').value, side: document.getElementById('modal-side').value, price: document.getElementById('modal-price').value, units: parseFloat(document.getElementById('modal-units').value), result: 'Pending', profit: 0, notes: document.getElementById('modal-notes').value, id: Date.now() });
  localStorage.setItem('betLog', JSON.stringify(state.betLog));
  renderBetLog(); closeModal();
}

function renderBetLog() {
  const tbody = document.getElementById('bet-log-body');
  if (!state.betLog.length) { tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No bets logged yet.</td></tr>'; updateLogStats(); return; }
  tbody.innerHTML = state.betLog.slice().reverse().map(b => {
    const rc = b.result==='W'?'move-up':b.result==='L'?'move-down':'';
    const stratBadge = b.strategy === '3PT Regression' ? 'signal-purple' : 'signal-strong';
    return `<tr><td>${b.date}</td><td><span class="signal-badge ${stratBadge}">${b.strategy}</span></td><td>${b.game}</td><td>${b.side}</td><td>${b.price}</td><td>${b.units}</td><td class="${rc}">${b.result}</td><td class="${b.profit>=0?'move-up':'move-down'}">${b.profit>0?'+':''}${b.profit.toFixed(2)}u</td><td>${b.result==='Pending'?`<button class="btn btn-green btn-sm" onclick="resolveBet(${b.id},'W')">W</button> <button class="btn btn-red btn-sm" onclick="resolveBet(${b.id},'L')">L</button> <button class="btn btn-outline btn-sm" onclick="resolveBet(${b.id},'Push')">Push</button>`:''}</td></tr>`;
  }).join('');
  updateLogStats();
}

function resolveBet(id, result) {
  const b = state.betLog.find(x => x.id === id); if (!b) return;
  b.result = result;
  if (result==='W') { const p = parseInt(b.price)||-110; b.profit = p > 0 ? b.units*(p/100) : b.units*(100/Math.abs(p)); }
  else if (result==='L') b.profit = -b.units;
  else b.profit = 0;
  localStorage.setItem('betLog', JSON.stringify(state.betLog)); renderBetLog();
}

function updateLogStats() {
  const r = state.betLog.filter(b => b.result!=='Pending'), w = r.filter(b => b.result==='W').length, t = r.length;
  const nu = r.reduce((s,b) => s+b.profit, 0), tr = r.reduce((s,b) => s+b.units, 0);
  document.getElementById('log-total').textContent = state.betLog.length;
  document.getElementById('log-winrate').textContent = t > 0 ? (w/t*100).toFixed(1)+'%' : '-';
  document.getElementById('log-net-units').textContent = (nu>=0?'+':'')+nu.toFixed(2);
  document.getElementById('log-net-units').className = `stat-value ${nu>=0?'green':'red'}`;
  document.getElementById('log-roi').textContent = tr > 0 ? (nu/tr*100).toFixed(1)+'%' : '-';
  let streak = 0, st = '';
  for (let i = r.length-1; i >= 0; i--) { if (i===r.length-1) { st=r[i].result; streak=1; } else if (r[i].result===st) streak++; else break; }
  const se = document.getElementById('log-streak');
  if (streak > 0) { se.textContent = streak+st; se.className = `stat-value ${st==='W'?'green':st==='L'?'red':''}`; }
  else se.textContent = '-';
}

function clearLog() { if (confirm('Clear ALL bets?')) { state.betLog = []; localStorage.setItem('betLog','[]'); renderBetLog(); } }
function exportLog() {
  if (!state.betLog.length) { alert('No bets'); return; }
  const h = 'Date,Strategy,Game,Side,Price,Units,Result,Profit,Notes\n';
  const r = state.betLog.map(b => `${b.date},${b.strategy},"${b.game}",${b.side},${b.price},${b.units},${b.result},${b.profit.toFixed(2)},"${b.notes}"`).join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([h+r],{type:'text/csv'})); a.download = `NBA_Edge_BetLog_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

// ==================== BANKROLL ====================
function updateBankroll() {
  const s = parseFloat(document.getElementById('bankroll-start').value)||0, c = parseFloat(document.getElementById('bankroll-current').value)||0;
  state.bankroll = { start:s, current:c }; localStorage.setItem('bankroll', JSON.stringify(state.bankroll));
  const u = c*0.01;
  document.getElementById('br-unit').textContent = u > 0 ? '$'+u.toFixed(0) : '-';
  document.getElementById('br-max').textContent = u > 0 ? '$'+(u*2).toFixed(0) : '-';
  document.getElementById('br-daily').textContent = u > 0 ? '$'+(u*5).toFixed(0) : '-';
  const pl = c-s;
  document.getElementById('br-pl').textContent = s > 0 ? (pl>=0?'+':'')+`$${pl.toFixed(0)}` : '-';
  document.getElementById('br-pl').className = `stat-value ${pl>=0?'green':'red'}`;
  const pct = s > 0 ? (pl/s*100) : 0;
  document.getElementById('br-pl-pct').textContent = s > 0 ? (pct>=0?'+':'')+pct.toFixed(1)+'%' : '-';
  document.getElementById('br-pl-pct').className = `stat-value ${pct>=0?'green':'red'}`;
}

document.getElementById('logModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
</script>
</body>
</html>
